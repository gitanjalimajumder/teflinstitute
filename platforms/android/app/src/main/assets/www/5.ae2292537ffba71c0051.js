(window.webpackJsonp=window.webpackJsonp||[]).push([[5,67],{"8/zp":function(e,o,s){"use strict";s.r(o),s.d(o,"AddonModWorkshopHelperProvider",(function(){return A})),s.d(o,"AddonModWorkshopHelper",(function(){return k}));var d=s("mrSG"),i=s("93ts"),r=s("hSQQ"),n=s("EmGO"),t=s("9+EE"),a=s("vuGA"),l=s("bFG1"),c=s("j3ag"),u=s("49BL"),h=s("i1f9"),m=s("EyWp"),p=s("DJrq"),f=s("fXoL");let A=(()=>{class AddonModWorkshopHelperProvider{getTask(e,o){return e.find((e=>e.code==o))}isTaskDone(e,o){const s=this.getTask(e,o);return!s||!!s.completed}canSubmit(e,o,s){const d=e.useexamples&&e.examplesmode==h.AddonModWorkshopExampleMode.EXAMPLES_BEFORE_SUBMISSION,i=o.canmanageexamples||e.examplesmode==h.AddonModWorkshopExampleMode.EXAMPLES_VOLUNTARY||this.isTaskDone(s,"examples");return e.phase>h.AddonModWorkshopPhase.PHASE_SETUP&&o.cansubmit&&(!d||i)}canAssess(e,o){return!(e.useexamples&&e.examplesmode==h.AddonModWorkshopExampleMode.EXAMPLES_BEFORE_ASSESSMENT)||o.canmanageexamples}getUserSubmission(e,o={}){return Object(d.a)(this,void 0,void 0,(function*(){const s=o.userId||t.b.getCurrentSiteUserId();return(yield h.AddonModWorkshop.getSubmissions(e,o)).find((e=>e.authorid==s))}))}getSubmissionById(e,o,s={}){return Object(d.a)(this,void 0,void 0,(function*(){try{return yield h.AddonModWorkshop.getSubmission(e,o,s)}catch(d){const r=(yield h.AddonModWorkshop.getSubmissions(e,s)).find((e=>e.id==o));if(!r)throw new i.a("Submission not found");return r}}))}getReviewerAssessmentById(e,o,s={}){return Object(d.a)(this,void 0,void 0,(function*(){let d;try{d=yield h.AddonModWorkshop.getAssessment(e,o,s)}catch(i){if(d=(yield h.AddonModWorkshop.getReviewerAssessments(e,s)).find((e=>e.id===o)),!d)throw i}return d.form=yield h.AddonModWorkshop.getAssessmentForm(e,o,s),d}))}getReviewerAssessments(e,o={}){return Object(d.a)(this,void 0,void 0,(function*(){o.siteId=o.siteId||t.b.getCurrentSiteId();const s=yield h.AddonModWorkshop.getReviewerAssessments(e,o),d=[];return s.forEach((s=>{d.push(this.getSubmissionById(e,s.submissionid,o).then((e=>{s.submission=e}))),d.push(h.AddonModWorkshop.getAssessmentForm(e,s.id,o).then((e=>{s.form=e})))})),yield Promise.all(d),s}))}deleteSubmissionStoredFiles(e,o){return Object(d.a)(this,void 0,void 0,(function*(){const s=yield m.AddonModWorkshopOffline.getSubmissionFolder(e,o);yield l.a.ignoreErrors(n.a.removeDir(s))}))}storeSubmissionFiles(e,o,s){return Object(d.a)(this,void 0,void 0,(function*(){const d=yield m.AddonModWorkshopOffline.getSubmissionFolder(e,s);return r.a.storeFilesToUpload(d,o)}))}uploadOrStoreSubmissionFiles(e,o,s,d){return s?this.storeSubmissionFiles(e,o,d):r.a.uploadOrReuploadFiles(o,p.a,e,d)}getStoredSubmissionFiles(e,o){return Object(d.a)(this,void 0,void 0,(function*(){const s=yield m.AddonModWorkshopOffline.getSubmissionFolder(e,o);return l.a.ignoreErrors(r.a.getStoredFiles(s),[])}))}getSubmissionFilesFromOfflineFilesObject(e,o,s){return Object(d.a)(this,void 0,void 0,(function*(){const d=yield m.AddonModWorkshopOffline.getSubmissionFolder(o,s);return r.a.getStoredFilesFromOfflineFilesObject(e,d)}))}deleteAssessmentStoredFiles(e,o,s){return Object(d.a)(this,void 0,void 0,(function*(){const d=yield m.AddonModWorkshopOffline.getAssessmentFolder(e,o,s);yield l.a.ignoreErrors(n.a.removeDir(d))}))}storeAssessmentFiles(e,o,s,i){return Object(d.a)(this,void 0,void 0,(function*(){const d=yield m.AddonModWorkshopOffline.getAssessmentFolder(e,o,i);return r.a.storeFilesToUpload(d,s)}))}uploadOrStoreAssessmentFiles(e,o,s,d,i){return d?this.storeAssessmentFiles(e,o,s,i):r.a.uploadOrReuploadFiles(s,p.a,e,i)}getStoredAssessmentFiles(e,o,s){return Object(d.a)(this,void 0,void 0,(function*(){const d=yield m.AddonModWorkshopOffline.getAssessmentFolder(e,o,s);return l.a.ignoreErrors(r.a.getStoredFiles(d),[])}))}getAssessmentFilesFromOfflineFilesObject(e,o,s,i){return Object(d.a)(this,void 0,void 0,(function*(){const d=yield m.AddonModWorkshopOffline.getAssessmentFolder(o,s,i);return r.a.getStoredFilesFromOfflineFilesObject(e,d)}))}applyOfflineData(e={id:0,workshopid:0,title:"",content:"",timemodified:0,example:!1,authorid:0,timecreated:0,contenttrust:0,attachment:0,published:!1,late:0},o=[]){return Object(d.a)(this,void 0,void 0,(function*(){if(0===o.length)return e;let s;const d=o[0].workshopid;return o.forEach((o=>{switch(o.action){case h.AddonModWorkshopAction.ADD:case h.AddonModWorkshopAction.UPDATE:e.title=o.title,e.content=o.content,e.title=o.title,e.courseid=o.courseid,e.submissionmodified=o.timemodified/1e3,e.offline=!0,s=o.attachmentsid;break;case h.AddonModWorkshopAction.DELETE:e.deleted=!0,e.submissionmodified=o.timemodified/1e3}})),e.attachmentfiles=s?yield this.getSubmissionFilesFromOfflineFilesObject(s,d):[],e}))}prepareAssessmentData(e,o,s,i,r=0){var n;return Object(d.a)(this,void 0,void 0,(function*(){if(e.overallfeedbackmode==h.AddonModWorkshopOverallFeedbackMode.ENABLED_REQUIRED&&!s){throw{feedbackauthor:c.I.instant("core.err_required")}}const d=(yield u.AddonWorkshopAssessmentStrategyDelegate.prepareAssessmentData(null!==(n=e.strategy)&&void 0!==n?n:"",o,i))||{};return d.feedbackauthor=s,d.feedbackauthorformat=a.a.FORMAT_HTML,d.feedbackauthorattachmentsid=r,d.nodims=i.dimenssionscount,d}))}realGradeValueHelper(e,o=0,s=0){return"string"==typeof e?e:null!=e?0===o?"0":(e=a.b.roundToDecimals(o*e/100,s),l.a.formatFloat(e)):void 0}realGradeValue(e,o){return o.grade=this.realGradeValueHelper(o.grade,e.grade,e.gradedecimals),o.gradinggrade=this.realGradeValueHelper(o.gradinggrade,e.gradinggrade,e.gradedecimals),o.gradinggradeover=this.realGradeValueHelper(o.gradinggradeover,e.gradinggrade,e.gradedecimals),o}showGrade(e){return null!=e}}return AddonModWorkshopHelperProvider.ɵfac=function AddonModWorkshopHelperProvider_Factory(e){return new(e||AddonModWorkshopHelperProvider)},AddonModWorkshopHelperProvider.ɵprov=f.uc({token:AddonModWorkshopHelperProvider,factory:AddonModWorkshopHelperProvider.ɵfac,providedIn:"root"}),AddonModWorkshopHelperProvider})();const k=Object(c.M)(A)},GuJL:function(e,o,s){"use strict";s.r(o),s.d(o,"AddonModWorkshopSyncProvider",(function(){return b})),s.d(o,"AddonModWorkshopSync",(function(){return y}));var d=s("mrSG"),i=s("wl8P"),r=s("+mW7"),n=s("TmfO"),t=s("GGba"),a=s("9+EE"),l=s("uT8i"),c=s("vuGA"),u=s("bFG1"),h=s("j3ag"),m=s("fjkH"),p=s("i1f9"),f=s("8/zp"),A=s("EyWp"),k=s("DJrq"),g=s("fXoL");let b=(()=>{class AddonModWorkshopSyncProvider extends i.a{constructor(){super("AddonModWorkshopSyncProvider"),this.componentTranslatableString="workshop"}hasDataToSync(e,o){return A.AddonModWorkshopOffline.hasWorkshopOfflineData(e,o)}syncAllWorkshops(e,o){return this.syncOnSites("all workshops",(e=>this.syncAllWorkshopsFunc(!!o,e)),e)}syncAllWorkshopsFunc(e,o){return Object(d.a)(this,void 0,void 0,(function*(){const s=(yield A.AddonModWorkshopOffline.getAllWorkshops(o)).map((s=>Object(d.a)(this,void 0,void 0,(function*(){const d=e?yield this.syncWorkshop(s,o):yield this.syncWorkshopIfNeeded(s,o);d&&d.updated&&m.b.trigger(AddonModWorkshopSyncProvider.AUTO_SYNCED,{workshopId:s,warnings:d.warnings},o)}))));yield Promise.all(s)}))}syncWorkshopIfNeeded(e,o){return Object(d.a)(this,void 0,void 0,(function*(){if(yield this.isSyncNeeded(e,o))return this.syncWorkshop(e,o)}))}syncWorkshop(e,o){o=o||a.b.getCurrentSiteId();const s=this.getOngoingSync(e,o);if(s)return s;if(l.a.isBlocked(k.a,e,o))throw this.logger.debug(`Cannot sync workshop '${e}' because it is blocked.`),new i.b(h.I.instant("core.errorsyncblocked",{$a:this.componentTranslate}));this.logger.debug(`Try to sync workshop '${e}' in site ${o}'`);const d=this.performSyncWorkshop(e,o);return this.addOngoingSync(e,d,o)}performSyncWorkshop(e,o){return Object(d.a)(this,void 0,void 0,(function*(){const s={warnings:[],updated:!1};yield u.a.ignoreErrors(n.a.syncActivity(k.a,e,o));const d=yield Promise.all([u.a.ignoreErrors(A.AddonModWorkshopOffline.getSubmissions(e,o),[]),u.a.ignoreErrors(A.AddonModWorkshopOffline.getAssessments(e,o),[]),u.a.ignoreErrors(A.AddonModWorkshopOffline.getEvaluateSubmissions(e,o),[]),u.a.ignoreErrors(A.AddonModWorkshopOffline.getEvaluateAssessments(e,o),[])]);let i;for(const e in d)if(d[e].length>0&&d[e][0].courseid){i=d[e][0].courseid;break}if(!i)return yield u.a.ignoreErrors(this.setSyncTime(e,o)),s;if(!t.a.isOnline())throw new r.a;const a=yield p.AddonModWorkshop.getWorkshopById(i,e,{siteId:o}),l=d[1],c=d[2],h=d[3],m={},f=[];return d[0].forEach((e=>{m[e.submissionid]=m[e.submissionid]||[],m[e.submissionid].push(e)})),Object.keys(m).forEach((e=>{f.push(this.syncSubmission(a,m[e],s,o).then((()=>{s.updated=!0})))})),l.forEach((e=>{f.push(this.syncAssessment(a,e,s,o).then((()=>{s.updated=!0})))})),c.forEach((e=>{f.push(this.syncEvaluateSubmission(a,e,s,o).then((()=>{s.updated=!0})))})),h.forEach((e=>{f.push(this.syncEvaluateAssessment(a,e,s,o).then((()=>{s.updated=!0})))})),yield Promise.all(f),s.updated&&(yield u.a.ignoreErrors(p.AddonModWorkshop.invalidateContentById(e,i,o))),yield u.a.ignoreErrors(this.setSyncTime(e,o)),s}))}syncSubmission(e,o,s,i){return Object(d.a)(this,void 0,void 0,(function*(){let r,n=0,t=(o=o.sort(((e,o)=>e.timemodified-o.timemodified)))[0].submissionid;if(t>0)try{n=(yield p.AddonModWorkshop.getSubmission(e.id,t,{cmId:e.coursemodule,siteId:i})).timemodified}catch(e){n=-1}if(n<0||n>=o[0].timemodified)return s.updated=!0,r=h.I.instant("addon.mod_workshop.warningsubmissionmodified"),yield A.AddonModWorkshopOffline.deleteAllSubmissionActions(e.id,i),this.addOfflineDataDeletedWarning(s.warnings,e.name,r),void 0;o.forEach((o=>Object(d.a)(this,void 0,void 0,(function*(){t=o.submissionid>0?o.submissionid:t;try{let s;if(o.attachmentsid){const d=yield f.AddonModWorkshopHelper.getSubmissionFilesFromOfflineFilesObject(o.attachmentsid,e.id,i);s=yield f.AddonModWorkshopHelper.uploadOrStoreSubmissionFiles(e.id,d,!1,i)}else s=yield f.AddonModWorkshopHelper.uploadOrStoreSubmissionFiles(e.id,[],!1,i);switch(e.submissiontypefile==p.AddonModWorkshopSubmissionType.SUBMISSION_TYPE_DISABLED&&(s=void 0),o.action){case p.AddonModWorkshopAction.ADD:t=yield p.AddonModWorkshop.addSubmissionOnline(e.id,o.title,o.content,s,i);break;case p.AddonModWorkshopAction.UPDATE:yield p.AddonModWorkshop.updateSubmissionOnline(t,o.title,o.content,s,i);break;case p.AddonModWorkshopAction.DELETE:yield p.AddonModWorkshop.deleteSubmissionOnline(t,i)}}catch(e){throw e&&u.a.isWebServiceError(e)&&(r=c.b.getErrorMessageFromError(e)),e}if(s.updated=!0,yield A.AddonModWorkshopOffline.deleteSubmissionAction(o.workshopid,o.action,i),o.action==p.AddonModWorkshopAction.ADD||o.action==p.AddonModWorkshopAction.UPDATE)return f.AddonModWorkshopHelper.deleteSubmissionStoredFiles(o.workshopid,i)})))),r&&this.addOfflineDataDeletedWarning(s.warnings,e.name,r)}))}syncAssessment(e,o,s,i){return Object(d.a)(this,void 0,void 0,(function*(){let d;const r=o.assessmentid;let n=0;try{n=(yield p.AddonModWorkshop.getAssessment(e.id,r,{cmId:e.coursemodule,siteId:i})).timemodified}catch(e){n=-1}if(n<0||n>=o.timemodified)return s.updated=!0,d=h.I.instant("addon.mod_workshop.warningassessmentmodified"),yield A.AddonModWorkshopOffline.deleteAssessment(e.id,r,i),this.addOfflineDataDeletedWarning(s.warnings,e.name,d),void 0;let t=0;const a=o.inputdata;try{let o=[];a.feedbackauthorattachmentsid&&"number"!=typeof a.feedbackauthorattachmentsid&&(o=yield f.AddonModWorkshopHelper.getAssessmentFilesFromOfflineFilesObject(a.feedbackauthorattachmentsid,e.id,r,i)),t=yield f.AddonModWorkshopHelper.uploadOrStoreAssessmentFiles(e.id,r,o,!1,i),a.feedbackauthorattachmentsid=t||0,yield p.AddonModWorkshop.updateAssessmentOnline(r,a,i)}catch(e){if(!e||!u.a.isWebServiceError(e))throw e;d=c.b.getErrorMessageFromError(e)}s.updated=!0,yield A.AddonModWorkshopOffline.deleteAssessment(e.id,r,i),yield f.AddonModWorkshopHelper.deleteAssessmentStoredFiles(e.id,r,i),d&&this.addOfflineDataDeletedWarning(s.warnings,e.name,d)}))}syncEvaluateSubmission(e,o,s,i){return Object(d.a)(this,void 0,void 0,(function*(){let d;const r=o.submissionid;let n=0;try{n=(yield p.AddonModWorkshop.getSubmission(e.id,r,{cmId:e.coursemodule,siteId:i})).timemodified}catch(e){n=-1}if(n<0||n>=o.timemodified)return s.updated=!0,d=h.I.instant("addon.mod_workshop.warningsubmissionmodified"),yield A.AddonModWorkshopOffline.deleteEvaluateSubmission(e.id,r,i),this.addOfflineDataDeletedWarning(s.warnings,e.name,d),void 0;try{yield p.AddonModWorkshop.evaluateSubmissionOnline(r,o.feedbacktext,o.published,o.gradeover,i)}catch(e){if(!e||!u.a.isWebServiceError(e))throw e;d=c.b.getErrorMessageFromError(e)}s.updated=!0,yield A.AddonModWorkshopOffline.deleteEvaluateSubmission(e.id,r,i),d&&this.addOfflineDataDeletedWarning(s.warnings,e.name,d)}))}syncEvaluateAssessment(e,o,s,i){return Object(d.a)(this,void 0,void 0,(function*(){let d;const r=o.assessmentid;let n=0;try{n=(yield p.AddonModWorkshop.getAssessment(e.id,r,{cmId:e.coursemodule,siteId:i})).timemodified}catch(e){n=-1}if(n<0||n>=o.timemodified)return s.updated=!0,d=h.I.instant("addon.mod_workshop.warningassessmentmodified"),A.AddonModWorkshopOffline.deleteEvaluateAssessment(e.id,r,i);try{yield p.AddonModWorkshop.evaluateAssessmentOnline(r,o.feedbacktext,o.weight,o.gradinggradeover,i)}catch(e){if(!e||!u.a.isWebServiceError(e))throw e;d=c.b.getErrorMessageFromError(e)}s.updated=!0,yield A.AddonModWorkshopOffline.deleteEvaluateAssessment(e.id,r,i),d&&this.addOfflineDataDeletedWarning(s.warnings,e.name,d)}))}}return AddonModWorkshopSyncProvider.AUTO_SYNCED="addon_mod_workshop_autom_synced",AddonModWorkshopSyncProvider.MANUAL_SYNCED="addon_mod_workshop_manual_synced",AddonModWorkshopSyncProvider.ɵfac=function AddonModWorkshopSyncProvider_Factory(e){return new(e||AddonModWorkshopSyncProvider)},AddonModWorkshopSyncProvider.ɵprov=g.uc({token:AddonModWorkshopSyncProvider,factory:AddonModWorkshopSyncProvider.ɵfac,providedIn:"root"}),AddonModWorkshopSyncProvider})();const y=Object(h.M)(b)}}]);