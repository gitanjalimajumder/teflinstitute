(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{ZQH4:function(e,t,a){"use strict";a.r(t),a.d(t,"AddonModGlossaryEditLazyModule",(function(){return S}));var n=a("L3Fv"),i=a("ekpb"),o=a("tyNb"),d=a("MLi9"),s=a("mrSG"),c=a("3Pt+"),l=a("93ts"),r=a("+mW7"),h=a("hSQQ"),g=a("pHTc"),m=a("GGba"),u=a("9+EE"),f=a("3LXp"),y=a("vuGA"),_=a("bFG1"),p=a("j3ag"),E=a("fjkH"),v=a("4reR"),M=a("gjmY"),b=a("BZ3K"),D=a("7DS8"),A=a("D7J2"),O=a("fXoL"),P=a("46ml"),G=a("TEn/"),I=a("ofXK"),C=a("nt/U"),w=a("PgjG"),k=a("hMzs"),T=a("N5Lt"),F=a("M9y5"),x=a("ACYt"),V=a("d0nH"),j=a("sYmb");const L=["editFormEl"];function AddonModGlossaryEditPage_h1_6_Template(e,t){if(1&e&&(O.Ec(0,"h1"),O.zc(1,"core-format-text",4),O.Dc()),2&e){const e=O.Oc();O.lc(1),O.Vc("text",e.glossary.name)("contextInstanceId",e.cmId)("courseId",e.courseId)}}function AddonModGlossaryEditPage_form_9_ion_item_14_ion_select_option_8_Template(e,t){if(1&e&&(O.Ec(0,"ion-select-option",13),O.pd(1),O.Dc()),2&e){const e=t.$implicit;O.Vc("value",e.id),O.lc(1),O.rd(" ",e.name," ")}}const _c1=function(e){return{header:e}};function AddonModGlossaryEditPage_form_9_ion_item_14_Template(e,t){if(1&e){const e=O.Fc();O.Ec(0,"ion-item"),O.Ec(1,"ion-label",6),O.pd(2),O.Pc(3,"translate"),O.Dc(),O.Ec(4,"ion-select",11),O.Mc("ngModelChange",(function AddonModGlossaryEditPage_form_9_ion_item_14_Template_ion_select_ngModelChange_4_listener(t){O.fd(e);return O.Oc(2).data.categories=t})),O.Pc(5,"translate"),O.Pc(6,"translate"),O.Pc(7,"translate"),O.nd(8,AddonModGlossaryEditPage_form_9_ion_item_14_ion_select_option_8_Template,2,2,"ion-select-option",12),O.Dc(),O.Dc()}if(2&e){const e=O.Oc(2);O.lc(2),O.rd(" ",O.Qc(3,6,"addon.mod_glossary.categories")," "),O.lc(2),O.Vc("ngModel",e.data.categories)("placeholder",O.Qc(5,8,"addon.mod_glossary.categories"))("cancelText",O.Qc(6,10,"core.cancel"))("interfaceOptions",O.ad(14,_c1,O.Qc(7,12,"addon.mod_glossary.categories"))),O.lc(4),O.Vc("ngForOf",e.categories)}}function AddonModGlossaryEditPage_form_9_ion_item_15_Template(e,t){if(1&e){const e=O.Fc();O.Ec(0,"ion-item"),O.Ec(1,"ion-label",6),O.pd(2),O.Pc(3,"translate"),O.Dc(),O.Ec(4,"ion-textarea",14),O.Mc("ngModelChange",(function AddonModGlossaryEditPage_form_9_ion_item_15_Template_ion_textarea_ngModelChange_4_listener(t){O.fd(e);return O.Oc(2).data.aliases=t})),O.Dc(),O.Dc()}if(2&e){const e=O.Oc(2);O.lc(2),O.rd(" ",O.Qc(3,3,"addon.mod_glossary.aliases")," "),O.lc(2),O.Vc("ngModel",e.data.aliases)("core-auto-rows",e.data.aliases)}}function AddonModGlossaryEditPage_form_9_ng_container_22_Template(e,t){if(1&e){const e=O.Fc();O.Cc(0),O.Ec(1,"ion-item-divider"),O.Ec(2,"ion-label"),O.Ec(3,"h2"),O.pd(4),O.Pc(5,"translate"),O.Dc(),O.Dc(),O.Dc(),O.Ec(6,"ion-item",15),O.Ec(7,"ion-label"),O.pd(8),O.Pc(9,"translate"),O.Dc(),O.Ec(10,"ion-toggle",16),O.Mc("ngModelChange",(function AddonModGlossaryEditPage_form_9_ng_container_22_Template_ion_toggle_ngModelChange_10_listener(t){O.fd(e);return O.Oc(2).data.usedynalink=t})),O.Dc(),O.Dc(),O.Ec(11,"ion-item",15),O.Ec(12,"ion-label"),O.pd(13),O.Pc(14,"translate"),O.Dc(),O.Ec(15,"ion-toggle",17),O.Mc("ngModelChange",(function AddonModGlossaryEditPage_form_9_ng_container_22_Template_ion_toggle_ngModelChange_15_listener(t){O.fd(e);return O.Oc(2).data.casesensitive=t})),O.Dc(),O.Dc(),O.Ec(16,"ion-item",15),O.Ec(17,"ion-label"),O.pd(18),O.Pc(19,"translate"),O.Dc(),O.Ec(20,"ion-toggle",18),O.Mc("ngModelChange",(function AddonModGlossaryEditPage_form_9_ng_container_22_Template_ion_toggle_ngModelChange_20_listener(t){O.fd(e);return O.Oc(2).data.fullmatch=t})),O.Dc(),O.Dc(),O.Bc()}if(2&e){const e=O.Oc(2);O.lc(4),O.qd(O.Qc(5,9,"addon.mod_glossary.linking")),O.lc(4),O.qd(O.Qc(9,11,"addon.mod_glossary.entryusedynalink")),O.lc(2),O.Vc("ngModel",e.data.usedynalink),O.lc(3),O.qd(O.Qc(14,13,"addon.mod_glossary.casesensitive")),O.lc(2),O.Vc("disabled",!e.data.usedynalink)("ngModel",e.data.casesensitive),O.lc(3),O.qd(O.Qc(19,15,"addon.mod_glossary.fullmatch")),O.lc(2),O.Vc("disabled",!e.data.usedynalink)("ngModel",e.data.fullmatch)}}function AddonModGlossaryEditPage_form_9_Template(e,t){if(1&e){const e=O.Fc();O.Ec(0,"form",null,5),O.Ec(2,"ion-item"),O.Ec(3,"ion-label",6),O.pd(4),O.Pc(5,"translate"),O.Dc(),O.Ec(6,"ion-input",7),O.Mc("ngModelChange",(function AddonModGlossaryEditPage_form_9_Template_ion_input_ngModelChange_6_listener(t){O.fd(e);return O.Oc().data.concept=t})),O.Pc(7,"translate"),O.Dc(),O.Dc(),O.Ec(8,"ion-item"),O.Ec(9,"ion-label",6),O.pd(10),O.Pc(11,"translate"),O.Dc(),O.Ec(12,"core-rich-text-editor",8),O.Mc("contentChanged",(function AddonModGlossaryEditPage_form_9_Template_core_rich_text_editor_contentChanged_12_listener(t){O.fd(e);return O.Oc().onDefinitionChange(t)})),O.Pc(13,"translate"),O.Dc(),O.Dc(),O.nd(14,AddonModGlossaryEditPage_form_9_ion_item_14_Template,9,16,"ion-item",2),O.nd(15,AddonModGlossaryEditPage_form_9_ion_item_15_Template,5,5,"ion-item",2),O.Ec(16,"ion-item-divider"),O.Ec(17,"ion-label"),O.Ec(18,"h2"),O.pd(19),O.Pc(20,"translate"),O.Dc(),O.Dc(),O.Dc(),O.zc(21,"core-attachments",9),O.nd(22,AddonModGlossaryEditPage_form_9_ng_container_22_Template,21,17,"ng-container",2),O.Ec(23,"ion-button",10),O.Mc("click",(function AddonModGlossaryEditPage_form_9_Template_ion_button_click_23_listener(){O.fd(e);return O.Oc().save()})),O.pd(24),O.Pc(25,"translate"),O.Dc(),O.Dc()}if(2&e){const e=O.Oc();O.lc(4),O.qd(O.Qc(5,22,"addon.mod_glossary.concept")),O.lc(2),O.Vc("placeholder",O.Qc(7,24,"addon.mod_glossary.concept"))("ngModel",e.data.concept),O.lc(4),O.qd(O.Qc(11,26,"addon.mod_glossary.definition")),O.lc(2),O.Vc("control",e.definitionControl)("placeholder",O.Qc(13,28,"addon.mod_glossary.definition"))("component",e.component)("componentId",e.cmId)("autoSave",!0)("contextInstanceId",e.cmId)("draftExtraParams",e.editorExtraParams),O.lc(2),O.Vc("ngIf",e.categories.length>0),O.lc(1),O.Vc("ngIf",e.showAliases),O.lc(4),O.qd(O.Qc(20,30,"addon.mod_glossary.attachment")),O.lc(2),O.Vc("files",e.data.attachments)("component",e.component)("componentId",e.glossary.coursemodule)("allowOffline",!0)("courseId",e.courseId),O.lc(1),O.Vc("ngIf",e.glossary.usedynalink),O.lc(1),O.Vc("disabled",!e.data.concept||!e.data.definition),O.lc(1),O.rd(" ",O.Qc(25,32,"core.save")," ")}}let H=(()=>{class AddonModGlossaryEditPage{constructor(e,t){this.route=e,this.splitView=t,this.component=M.b.COMPONENT,this.loaded=!1,this.definitionControl=new c.g,this.categories=[],this.showAliases=!0,this.editorExtraParams={},this.data={concept:"",definition:"",timecreated:0,attachments:[],categories:[],aliases:"",usedynalink:!1,casesensitive:!1,fullmatch:!1},this.isDestroyed=!1,this.saved=!1}ngOnInit(){return Object(s.a)(this,void 0,void 0,(function*(){try{const e=g.a.getRouteParam("entrySlug");if(this.cmId=g.a.getRequiredRouteNumberParam("cmId"),this.courseId=g.a.getRequiredRouteNumberParam("courseId"),null==e?void 0:e.startsWith("new-")){const t=Number(e.slice(4));this.editorExtraParams.timecreated=t,this.handler=new edit_AddonModGlossaryOfflineFormHandler(this,t)}else if(e){const{entry:t}=yield M.a.getEntry(Number(e));this.entry=t,this.editorExtraParams.timecreated=t.timecreated,this.handler=new edit_AddonModGlossaryOnlineFormHandler(this,t)}else this.handler=new edit_AddonModGlossaryNewFormHandler(this)}catch(e){return f.a.showErrorModal(e),this.goBack(),void 0}this.fetchData()}))}fetchData(){return Object(s.a)(this,void 0,void 0,(function*(){try{if(this.glossary=yield M.a.getGlossary(this.courseId,this.cmId),yield this.handler.loadData(this.glossary),this.loaded=!0,this.handler instanceof edit_AddonModGlossaryOfflineFormHandler)return;A.a.logEvent({type:A.b.VIEW_ITEM,ws:"mod_glossary_get_glossaries_by_courses",name:this.glossary.name,data:{id:this.glossary.id,category:"glossary"},url:"/mod/glossary/edit.php"+(this.entry?`?cmid=${this.cmId}&id=${this.entry.id}`:"")})}catch(e){f.a.showErrorModalDefault(e,"addon.mod_glossary.errorloadingglossary",!0),this.goBack()}}))}resetForm(){this.originalData=void 0,this.data.concept="",this.data.definition="",this.data.timecreated=0,this.data.categories=[],this.data.aliases="",this.data.usedynalink=!1,this.data.casesensitive=!1,this.data.fullmatch=!1,this.data.attachments.length=0,this.definitionControl.setValue("")}onDefinitionChange(e){this.data.definition=null!=e?e:""}canLeave(){return Object(s.a)(this,void 0,void 0,(function*(){return this.saved||(this.hasDataChanged()&&(yield f.a.showConfirm(p.I.instant("core.confirmcanceledit"))),h.a.clearTmpFiles(this.data.attachments),v.a.triggerFormCancelledEvent(this.formElement,u.b.getCurrentSiteId())),!0}))}save(){return Object(s.a)(this,void 0,void 0,(function*(){if(!this.data.concept||!this.data.definition)return f.a.showErrorModal("addon.mod_glossary.fillfields",!0),void 0;if(!this.glossary)return;const e=yield f.a.showModalLoading("core.sending",!0);try{const e=yield this.handler.save(this.glossary);this.saved=!0,v.a.triggerFormSubmittedEvent(this.formElement,e,u.b.getCurrentSiteId()),this.goBack()}catch(e){f.a.showErrorModalDefault(e,"addon.mod_glossary.cannoteditentry",!0)}finally{e.dismiss()}}))}hasDataChanged(){return this.originalData&&void 0!==this.originalData.concept?this.originalData.definition!=this.data.definition||this.originalData.concept!=this.data.concept||h.a.areFileListDifferent(this.data.attachments,this.originalData.attachments):!!(this.data.definition||this.data.concept||this.data.attachments.length>0)}goBack(){var e;(null===(e=this.splitView)||void 0===e?void 0:e.outletActivated)?g.a.navigate("../../"):g.a.back()}}return AddonModGlossaryEditPage.ɵfac=function AddonModGlossaryEditPage_Factory(e){return new(e||AddonModGlossaryEditPage)(O.yc(o.a),O.yc(P.a,8))},AddonModGlossaryEditPage.ɵcmp=O.sc({type:AddonModGlossaryEditPage,selectors:[["page-addon-mod-glossary-edit"]],viewQuery:function AddonModGlossaryEditPage_Query(e,t){var a;(1&e&&O.ud(L,!0),2&e)&&(O.dd(a=O.Nc())&&(t.formElement=a.first))},decls:10,vars:6,consts:[["slot","start"],[3,"text"],[4,"ngIf"],[3,"hideUntil"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["editFormEl",""],["position","stacked"],["type","text","name","concept",3,"placeholder","ngModel","ngModelChange"],["name","addon_mod_glossary_edit","contextLevel","module","elementId","definition_editor",3,"control","placeholder","component","componentId","autoSave","contextInstanceId","draftExtraParams","contentChanged"],[3,"files","component","componentId","allowOffline","courseId"],["expand","block",1,"ion-margin",3,"disabled","click"],["multiple","true","interface","action-sheet","name","categories",3,"ngModel","placeholder","cancelText","interfaceOptions","ngModelChange"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["rows","1","name","aliases",3,"ngModel","core-auto-rows","ngModelChange"],[1,"ion-text-wrap"],["name","usedynalink",3,"ngModel","ngModelChange"],["name","casesensitive",3,"disabled","ngModel","ngModelChange"],["name","fullmatch",3,"disabled","ngModel","ngModelChange"]],template:function AddonModGlossaryEditPage_Template(e,t){1&e&&(O.Ec(0,"ion-header"),O.Ec(1,"ion-toolbar"),O.Ec(2,"ion-buttons",0),O.zc(3,"ion-back-button",1),O.Pc(4,"translate"),O.Dc(),O.Ec(5,"ion-title"),O.nd(6,AddonModGlossaryEditPage_h1_6_Template,2,3,"h1",2),O.Dc(),O.Dc(),O.Dc(),O.Ec(7,"ion-content"),O.Ec(8,"core-loading",3),O.nd(9,AddonModGlossaryEditPage_form_9_Template,26,34,"form",2),O.Dc(),O.Dc()),2&e&&(O.lc(3),O.Vc("text",O.Qc(4,4,"core.back")),O.lc(3),O.Vc("ngIf",t.glossary),O.lc(2),O.Vc("hideUntil",t.loaded),O.lc(1),O.Vc("ngIf",t.glossary))},directives:[G.C,G.Ab,G.m,G.h,G.i,G.yb,I.t,C.a,G.v,w.a,k.a,c.H,c.s,c.t,G.I,G.O,G.H,G.Pb,c.r,c.u,T.a,G.J,F.a,x.a,G.l,G.lb,G.Ob,I.s,G.mb,G.wb,V.a,G.zb,G.d],pipes:[j.d],encapsulation:2}),AddonModGlossaryEditPage})();class edit_AddonModGlossaryFormHandler{constructor(e){this.page=e}loadCategories(e){return Object(s.a)(this,void 0,void 0,(function*(){this.page.categories=yield M.a.getAllCategories(e.id,{cmId:this.page.cmId})}))}uploadAttachments(e){return Object(s.a)(this,void 0,void 0,(function*(){const t=this.page.data;return yield h.a.uploadOrReuploadFiles(t.attachments,M.b.COMPONENT,e.id)}))}storeAttachments(e,t){return Object(s.a)(this,void 0,void 0,(function*(){const a=this.page.data;return yield b.a.storeFiles(e.id,a.concept,t,a.attachments)}))}checkDuplicates(e){return Object(s.a)(this,void 0,void 0,(function*(){if(e.allowduplicatedentries)return;const t=this.page.data;if(yield M.a.isConceptUsed(e.id,t.concept,{timeCreated:t.timecreated,cmId:this.page.cmId}))throw new l.a(p.I.instant("addon.mod_glossary.errconceptalreadyexists"))}))}getSaveOptions(e){const t=this.page.data,a={};return this.page.showAliases&&(a.aliases=t.aliases),this.page.categories.length>0&&(a.categories=t.categories.join(",")),e.usedynalink&&(a.usedynalink=t.usedynalink?1:0,t.usedynalink&&(a.casesensitive=t.casesensitive?1:0,a.fullmatch=t.fullmatch?1:0)),a}}class edit_AddonModGlossaryOfflineFormHandler extends edit_AddonModGlossaryFormHandler{constructor(e,t){super(e),this.timecreated=t}loadData(e){var t,a,n,i;return Object(s.a)(this,void 0,void 0,(function*(){const o=this.page.data,d=yield D.a.getOfflineEntry(e.id,this.timecreated);o.concept=d.concept||"",o.definition=d.definition||"",o.timecreated=d.timecreated,d.options&&(o.categories=(null!==(a=null===(t=d.options.categories)||void 0===t?void 0:t.split(","))&&void 0!==a?a:[]).map((e=>Number(e))),o.aliases=null!==(n=d.options.aliases)&&void 0!==n?n:"",o.usedynalink=!!d.options.usedynalink,o.usedynalink&&(o.casesensitive=!!d.options.casesensitive,o.fullmatch=!!d.options.fullmatch)),(null===(i=d.attachments)||void 0===i?void 0:i.offline)&&(o.attachments=yield b.a.getStoredFiles(e.id,d.concept,d.timecreated)),this.page.originalData={concept:o.concept,definition:o.definition,attachments:o.attachments.slice(),timecreated:o.timecreated,categories:o.categories.slice(),aliases:o.aliases,usedynalink:o.usedynalink,casesensitive:o.casesensitive,fullmatch:o.fullmatch},this.page.definitionControl.setValue(o.definition),yield this.loadCategories(e)}))}save(e){return Object(s.a)(this,void 0,void 0,(function*(){const t=this.page.data,a=this.page.data;let n;return a.attachments.length&&(n=yield this.storeAttachments(e,a.timecreated)),t.concept!==a.concept&&(yield b.a.deleteStoredFiles(e.id,t.concept,a.timecreated)),yield this.updateOfflineEntry(e,n),h.a.clearTmpFiles(a.attachments),!1}))}updateOfflineEntry(e,t){return Object(s.a)(this,void 0,void 0,(function*(){const a=this.page.originalData,n=this.page.data,i=this.getSaveOptions(e),o=y.b.formatHtmlLines(n.definition);a&&(yield this.checkDuplicates(e),yield D.a.updateOfflineEntry({glossaryid:e.id,courseid:this.page.courseId,concept:a.concept,timecreated:a.timecreated},n.concept,o,i,t))}))}}class edit_AddonModGlossaryNewFormHandler extends edit_AddonModGlossaryFormHandler{loadData(e){return Object(s.a)(this,void 0,void 0,(function*(){yield this.loadCategories(e)}))}save(e){return Object(s.a)(this,void 0,void 0,(function*(){const t=this.page.data,a=Date.now();let n,i;if(t.attachments.length)try{n=yield this.uploadAttachments(e)}catch(t){if(_.a.isWebServiceError(t))throw t;i=yield this.storeAttachments(e,a)}const o=i?yield this.createOfflineEntry(e,a,i):yield this.createOnlineEntry(e,a,n,!t.attachments.length);return h.a.clearTmpFiles(t.attachments),o&&(b.a.deleteStoredFiles(e.id,t.concept,a),E.b.trigger(E.b.ACTIVITY_DATA_SENT,{module:"glossary"})),!!o}))}createOfflineEntry(e,t,a){return Object(s.a)(this,void 0,void 0,(function*(){const n=this.page.data,i=this.getSaveOptions(e),o=y.b.formatHtmlLines(n.definition);yield this.checkDuplicates(e),yield D.a.addOfflineEntry(e.id,n.concept,o,this.page.courseId,t,i,a,void 0,void 0)}))}createOnlineEntry(e,t,a,n){return Object(s.a)(this,void 0,void 0,(function*(){const i=this.page.data,o=this.getSaveOptions(e),d=y.b.formatHtmlLines(i.definition);return yield M.a.addEntry(e.id,i.concept,d,this.page.courseId,o,a,{timeCreated:t,allowOffline:n,checkDuplicates:!e.allowduplicatedentries})}))}}class edit_AddonModGlossaryOnlineFormHandler extends edit_AddonModGlossaryFormHandler{constructor(e,t){super(e),this.entry=t}loadData(){return Object(s.a)(this,void 0,void 0,(function*(){const e=this.page.data;e.concept=this.entry.concept,e.definition=this.entry.definition||"",e.timecreated=this.entry.timecreated,e.usedynalink=this.entry.usedynalink,e.usedynalink&&(e.casesensitive=this.entry.casesensitive,e.fullmatch=this.entry.fullmatch),this.entry.attachments&&(e.attachments=this.entry.attachments),this.page.originalData={concept:e.concept,definition:e.definition,attachments:e.attachments.slice(),timecreated:e.timecreated,categories:e.categories.slice(),aliases:e.aliases,usedynalink:e.usedynalink,casesensitive:e.casesensitive,fullmatch:e.fullmatch},this.page.definitionControl.setValue(e.definition),this.page.showAliases=!1}))}save(e){return Object(s.a)(this,void 0,void 0,(function*(){if(!m.a.isOnline())throw new r.a;const t=this.page.data,a=this.getSaveOptions(e),n=y.b.formatHtmlLines(t.definition);let i;return t.attachments.length&&(i=yield this.uploadAttachments(e)),yield M.a.updateEntry(e.id,this.entry.id,t.concept,n,a,i),h.a.clearTmpFiles(t.attachments),E.b.trigger(E.b.ACTIVITY_DATA_SENT,{module:"glossary"}),!0}))}}const Q=[{path:"",component:H,canDeactivate:[d.a]}];let S=(()=>{class AddonModGlossaryEditLazyModule{}return AddonModGlossaryEditLazyModule.ɵmod=O.wc({type:AddonModGlossaryEditLazyModule}),AddonModGlossaryEditLazyModule.ɵinj=O.vc({factory:function AddonModGlossaryEditLazyModule_Factory(e){return new(e||AddonModGlossaryEditLazyModule)},imports:[[o.m.forChild(Q),n.a,i.a]]}),AddonModGlossaryEditLazyModule})();void(("undefined"==typeof ngJitMode||ngJitMode)&&O.kd(S,{declarations:[H],imports:[o.m,n.a,i.a]}))}}]);