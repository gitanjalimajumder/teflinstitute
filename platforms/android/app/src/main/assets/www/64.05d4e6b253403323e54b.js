(window.webpackJsonp=window.webpackJsonp||[]).push([[64],{u5Wa:function(i,t,e){"use strict";e.r(t),e.d(t,"AddonModWikiLazyModule",(function(){return tt}));var o=e("tyNb"),a=e("L3Fv"),d=e("QowF"),n=e("9Hu0"),s=e("ekpb"),r=e("MLi9"),c=e("mrSG"),l=e("93ts"),h=e("ULAo"),g=e("pHTc"),u=e("9+EE"),I=e("uT8i"),m=e("3LXp"),p=e("vuGA"),k=e("bFG1"),w=e("j3ag"),b=e("fjkH"),f=e("4reR"),E=e("IfL8"),P=e("JZ+O"),v=e("NH8Q"),_=e("D7J2"),y=e("fXoL"),M=e("3Pt+"),T=e("TEn/"),A=e("hMzs"),D=e("ACYt"),L=e("nt/U"),C=e("PgjG"),x=e("ofXK"),F=e("N5Lt"),W=e("sYmb");const O=["editPageForm"];function AddonModWikiEditPage_form_14_ion_item_2_Template(i,t){1&i&&(y.Ec(0,"ion-item",13),y.Ec(1,"ion-label",10),y.pd(2),y.Pc(3,"translate"),y.Dc(),y.zc(4,"ion-input",14),y.Pc(5,"translate"),y.Dc()),2&i&&(y.lc(2),y.qd(y.Qc(3,2,"addon.mod_wiki.newpagetitle")),y.lc(2),y.Vc("placeholder",y.Qc(5,4,"addon.mod_wiki.newpagetitle")))}function AddonModWikiEditPage_form_14_ion_item_9_Template(i,t){1&i&&(y.Ec(0,"ion-item",15),y.Ec(1,"ion-label"),y.Ec(2,"ion-badge",16),y.pd(3),y.Pc(4,"translate"),y.Dc(),y.Dc(),y.Dc()),2&i&&(y.lc(3),y.qd(y.Qc(4,1,"addon.mod_wiki.wrongversionlock")))}function AddonModWikiEditPage_form_14_Template(i,t){if(1&i&&(y.Ec(0,"form",7,8),y.nd(2,AddonModWikiEditPage_form_14_ion_item_2_Template,6,6,"ion-item",9),y.Ec(3,"ion-item"),y.Ec(4,"ion-label",10),y.pd(5),y.Pc(6,"translate"),y.Dc(),y.zc(7,"core-rich-text-editor",11),y.Pc(8,"translate"),y.Dc(),y.nd(9,AddonModWikiEditPage_form_14_ion_item_9_Template,5,3,"ion-item",12),y.Dc()),2&i){const i=y.Oc();y.Vc("formGroup",i.pageForm),y.lc(2),y.Vc("ngIf",i.canEditTitle),y.lc(3),y.qd(y.Qc(6,11,"core.content")),y.lc(2),y.Vc("control",i.contentControl)("placeholder",y.Qc(8,13,"core.content"))("component",i.component)("componentId",i.cmId)("autoSave",!0)("contextInstanceId",i.cmId)("draftExtraParams",i.editorExtraParams),y.lc(2),y.Vc("ngIf",i.wrongVersionLock)}}let N=(()=>{class AddonModWikiEditPage{constructor(i){this.formBuilder=i,this.canEditTitle=!1,this.loaded=!1,this.component=E.b.COMPONENT,this.wrongVersionLock=!1,this.editorExtraParams={},this.editing=!1,this.editOffline=!1,this.subwikiFiles=[],this.forceLeave=!1,this.isDestroyed=!1,this.contentControl=this.formBuilder.control(""),this.pageForm=this.formBuilder.group({})}ngOnInit(){return Object(c.a)(this,void 0,void 0,(function*(){this.cmId=g.a.getRouteNumberParam("cmId")||void 0,this.courseId=g.a.getRouteNumberParam("courseId")||void 0,this.subwikiId=g.a.getRouteNumberParam("subwikiId"),this.wikiId=g.a.getRouteNumberParam("wikiId"),this.pageId=g.a.getRouteNumberParam("pageId"),this.section=g.a.getRouteParam("section"),this.groupId=g.a.getRouteNumberParam("groupId"),this.userId=g.a.getRouteNumberParam("userId");const i=g.a.getRouteParam("pageTitle");this.originalTitle=i?p.b.cleanTags(i.replace(/\+/g," "),{singleLine:!0}):"",this.canEditTitle=!this.originalTitle,this.title=this.originalTitle?w.I.instant("addon.mod_wiki.editingpage",{$a:this.originalTitle}):w.I.instant("addon.mod_wiki.newpagehdr"),this.blockId=v.a.getSubwikiBlockId(this.subwikiId,this.wikiId,this.userId,this.groupId),this.pageForm.addControl("title",this.formBuilder.control(this.originalTitle)),this.pageForm.addControl("text",this.contentControl),I.a.blockOperation(this.component,this.blockId),this.pageId?(this.editorExtraParams.pageid=this.pageId,this.section&&(this.editorExtraParams.section=this.section)):this.originalTitle&&(this.editorExtraParams.pagetitle=this.originalTitle);try{if((yield this.fetchWikiPageData())&&!this.isDestroyed){const i=v.a.getSubwikiBlockId(this.subwikiId,this.wikiId,this.userId,this.groupId);i!==this.blockId&&(I.a.unblockOperation(this.component,this.blockId),this.blockId=i,I.a.blockOperation(this.component,this.blockId)),this.logView()}}finally{this.loaded=!0}}))}fetchWikiPageData(){return Object(c.a)(this,void 0,void 0,(function*(){let i=!1,t=!1;try{const t=this.blockId?yield v.a.waitForSync(this.blockId):void 0;if(this.pageId){this.canEditTitle=!1,this.editing=!0,this.editOffline=!1;const t=yield E.a.getPageContents(this.pageId,{cmId:this.cmId});this.pageForm.controls.title.setValue(t.title),this.wikiId=t.wikiid,this.subwikiId=t.subwikiid,this.title=w.I.instant("addon.mod_wiki.editingpage",{$a:t.title}),this.originalTitle=t.title,this.groupId=t.groupid,this.userId=t.userid,i=t.caneditpage,yield this.fetchModuleAndCourseId(),this.subwikiFiles=yield E.a.getSubwikiFiles(this.wikiId,{groupId:this.groupId,userId:this.userId,cmId:this.cmId});const e=yield E.a.getPageForEditing(this.pageId,this.section),o=p.b.replacePluginfileUrls(e.content||"",this.subwikiFiles);this.contentControl.setValue(o),this.originalContent=o,this.version=e.version,i&&(this.renewLockInterval=window.setInterval((()=>{this.renewLock()}),E.b.RENEW_LOCK_TIME))}else{const e=this.pageForm.controls.title.value;if(this.editing=!1,i=!!this.blockId,yield this.fetchModuleAndCourseId(),!this.wikiId&&this.cmId&&this.courseId){const i=yield h.a.getModule(this.cmId,this.courseId,void 0,!0);this.wikiId=i.instance}if(e){if(t){const i=t.created.find((i=>i.title==e));if(i&&i.pageId>0)return this.pageId=i.pageId,this.fetchWikiPageData()}const i=yield k.a.ignoreErrors(P.a.getNewPage(e,this.subwikiId,this.wikiId,this.userId,this.groupId));i?(this.contentControl.setValue(i.cachedcontent),this.originalContent=i.cachedcontent,this.editOffline=!0):this.editOffline=!1}else this.editOffline=!1}return!0}catch(i){return m.a.showErrorModalDefault(i,"Error getting wiki data."),t=!0,this.forceLeavePage(),!1}finally{i||t||(m.a.showAlert(w.I.instant("core.notice"),w.I.instant("addon.mod_wiki.cannoteditpage")),this.forceLeavePage())}}))}fetchModuleAndCourseId(){return Object(c.a)(this,void 0,void 0,(function*(){if(!this.wikiId||this.cmId&&this.courseId)return;const i=yield h.a.getModuleBasicInfoByInstance(this.wikiId,"wiki",{readingStrategy:1});this.cmId=i.id,this.courseId=i.course}))}forceLeavePage(){this.forceLeave=!0,g.a.back()}goToPage(i){this.wikiId&&(E.a.setEditedPageData({cmId:this.cmId,courseId:this.courseId,pageId:this.pageId,pageTitle:i,wikiId:this.wikiId,subwikiId:this.subwikiId,userId:this.userId,groupId:this.groupId}),this.forceLeavePage())}hasDataChanged(){const i=this.pageForm.value;return!(this.originalContent==i.text||!this.editing&&!i.text&&!i.title)}canLeave(){return Object(c.a)(this,void 0,void 0,(function*(){return this.forceLeave||(this.hasDataChanged()&&(yield m.a.showConfirm(w.I.instant("core.confirmcanceledit"))),f.a.triggerFormCancelledEvent(this.formElement,u.b.getCurrentSiteId())),!0}))}ionViewDidLeave(){setTimeout((()=>{E.a.consumeEditedPageData()}),200)}save(){return Object(c.a)(this,void 0,void 0,(function*(){const i=this.pageForm.value,t=i.title;let e=i.text;const o=yield m.a.showModalLoading("core.sending",!0);e=p.b.restorePluginfileUrls(e,this.subwikiFiles),e=p.b.formatHtmlLines(e);try{if(this.editing&&this.pageId)return yield E.a.editPage(this.pageId,e,this.section),f.a.triggerFormSubmittedEvent(this.formElement,!0,u.b.getCurrentSiteId()),yield E.a.invalidatePage(this.pageId),this.goToPage(t);if(!t)return o.dismiss(),m.a.showAlert(w.I.instant("core.notice"),w.I.instant("addon.mod_wiki.titleshouldnotbeempty")),void 0;if(!this.editOffline){if(yield k.a.ignoreErrors(P.a.getNewPage(t,this.subwikiId,this.wikiId,this.userId,this.groupId)))throw new l.a(w.I.instant("addon.mod_wiki.pageexists"))}const i=yield E.a.newPage(t,e,{subwikiId:this.subwikiId,wikiId:this.wikiId,userId:this.userId,groupId:this.groupId,cmId:this.cmId});if(f.a.triggerFormSubmittedEvent(this.formElement,i>0,u.b.getCurrentSiteId()),i<=0)return this.goToPage(t);b.b.trigger(b.b.ACTIVITY_DATA_SENT,{module:"wiki"}),this.pageId=i;const a=yield E.a.getPageContents(this.pageId,{cmId:this.cmId}),d=[];this.wikiId=a.wikiid,d.push(E.a.invalidateSubwikiPages(this.wikiId)),this.subwikiId||d.push(E.a.invalidateSubwikis(this.wikiId)),this.subwikiId=a.subwikiid,this.userId=a.userid,this.groupId=a.groupid,yield k.a.ignoreErrors(Promise.all(d)),b.b.trigger(E.b.PAGE_CREATED_EVENT,{pageId:this.pageId,subwikiId:this.subwikiId,pageTitle:t},u.b.getCurrentSiteId()),this.goToPage(t)}catch(i){m.a.showErrorModalDefault(i,"Error saving wiki data.")}finally{o.dismiss()}}))}renewLock(){return Object(c.a)(this,void 0,void 0,(function*(){if(!this.pageId)return;const i=yield E.a.getPageForEditing(this.pageId,this.section,!0);i.version&&this.version!=i.version&&(this.wrongVersionLock=!0)}))}logView(){var i,t,e;let o;if(this.pageId)o=`/mod/wiki/edit.php?pageid=${this.pageId}`+(this.section?`&section=${this.section.replace(/ /g,"+")}`:"");else if(this.originalTitle){const e=this.originalTitle.replace(/ /g,"+");o=this.subwikiId?`/mod/wiki/create.php?swid=${this.subwikiId}&title=${e}&action=new`:`/mod/wiki/create.php?wid=${this.wikiId}&group=${null!==(i=this.groupId)&&void 0!==i?i:0}&uid=${null!==(t=this.userId)&&void 0!==t?t:0}&title=${e}`}else o=`/mod/wiki/create.php?action=new&wid=${this.wikiId}&swid=${this.subwikiId}`;_.a.logEvent({type:_.b.VIEW_ITEM,ws:this.pageId?"mod_wiki_edit_page":"mod_wiki_new_page",name:null!==(e=this.originalTitle)&&void 0!==e?e:w.I.instant("addon.mod_wiki.newpagehdr"),data:{id:this.wikiId,subwiki:this.subwikiId,category:"wiki"},url:o})}ngOnDestroy(){this.isDestroyed=!0,clearInterval(this.renewLockInterval),this.blockId&&I.a.unblockOperation(this.component,this.blockId)}}return AddonModWikiEditPage.ɵfac=function AddonModWikiEditPage_Factory(i){return new(i||AddonModWikiEditPage)(y.yc(M.f))},AddonModWikiEditPage.ɵcmp=y.sc({type:AddonModWikiEditPage,selectors:[["page-addon-mod-wiki-edit"]],viewQuery:function AddonModWikiEditPage_Query(i,t){var e;(1&i&&y.ud(O,!0),2&i)&&(y.dd(e=y.Nc())&&(t.formElement=e.first))},decls:15,vars:11,consts:[["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end"],["fill","clear",3,"click"],[3,"hideUntil"],[3,"formGroup",4,"ngIf"],[3,"formGroup"],["editPageForm",""],["class","ion-text-wrap",4,"ngIf"],[1,"sr-only"],["name","wiki_page_content","contextLevel","module","elementId","newcontent_editor",3,"control","placeholder","component","componentId","autoSave","contextInstanceId","draftExtraParams"],["class","ion-text-center addon-mod_wiki-wrongversionlock",4,"ngIf"],[1,"ion-text-wrap"],["name","title","type","text","formControlName","title",3,"placeholder"],[1,"ion-text-center","addon-mod_wiki-wrongversionlock"],["color","danger",1,"ion-padding"]],template:function AddonModWikiEditPage_Template(i,t){1&i&&(y.Ec(0,"ion-header"),y.Ec(1,"ion-toolbar"),y.Ec(2,"ion-buttons",0),y.zc(3,"ion-back-button",1),y.Pc(4,"translate"),y.Dc(),y.Ec(5,"ion-title"),y.Ec(6,"h1"),y.zc(7,"core-format-text",2),y.Dc(),y.Dc(),y.Ec(8,"ion-buttons",3),y.Ec(9,"ion-button",4),y.Mc("click",(function AddonModWikiEditPage_Template_ion_button_click_9_listener(){return t.save()})),y.pd(10),y.Pc(11,"translate"),y.Dc(),y.Dc(),y.Dc(),y.Dc(),y.Ec(12,"ion-content"),y.Ec(13,"core-loading",5),y.nd(14,AddonModWikiEditPage_form_14_Template,10,15,"form",6),y.Dc(),y.Dc()),2&i&&(y.lc(3),y.Vc("text",y.Qc(4,7,"core.back")),y.lc(4),y.Vc("text",t.title)("contextInstanceId",t.cmId)("courseId",t.courseId),y.lc(3),y.rd(" ",y.Qc(11,9,"core.save")," "),y.lc(3),y.Vc("hideUntil",t.loaded),y.lc(1),y.Vc("ngIf",t.loaded))},directives:[T.C,T.Ab,T.m,T.h,T.i,T.yb,A.a,D.a,T.l,L.a,T.v,C.a,x.t,M.H,M.s,M.k,T.I,T.O,F.a,T.H,T.Pb,M.r,M.i,T.k],pipes:[W.d],encapsulation:2}),AddonModWikiEditPage})();var S=e("M9y5"),V=e("aEIl"),z=e("3zv0"),j=e("Lmwl"),J=e("4qNr"),R=e("fQ68"),Q=e("8/N+"),H=e("0QZc"),G=e("uHIS"),B=e("w+Pn"),$=e("r8G5"),q=e("5450"),U=e("W5pS"),K=e("WPIK"),Y=e("qNqN"),X=e("xpMl"),Z=e("FTxb"),ii=e("/K1O"),ti=e("FasJ"),ei=e("9pYf"),oi=e("eAud"),ai=e("ACV2"),di=e("/BoF"),ni=e("TKc2"),si=e("whRm"),ri=e("O4u7"),ci=e("lqoc"),li=e("3lz8"),hi=e("46ml"),gi=e("QQhE"),ui=e("MpCO"),Ii=e("JYLr"),mi=e("vWwc"),pi=e("NhJP"),ki=e("rztj"),wi=e("FeAf"),bi=e("rf3J"),fi=e("nEkO"),Ei=e("TF0o"),Pi=e("p5uK"),vi=e("ijlo"),_i=e("vFDU"),yi=e("6uVz"),Mi=e("d0nH"),Ti=e("NcPy"),Ai=e("yNDK"),Di=e("3CSS"),Li=e("iSJP"),Ci=e("iJls"),xi=e("ArDJ"),Fi=e("nu3w"),Wi=e("saTE"),Oi=e("8PoL"),Ni=e("4a38"),Si=e("4JiN"),Vi=e("OZH1"),zi=e("edOc"),ji=e("3jOR"),Ji=e("6A9T"),Ri=e("nKjD"),Qi=e("MqDN"),Hi=e("IBMc"),Gi=e("1iFe"),Bi=e("dne1"),$i=e("Cg42"),qi=e("llyR"),Ui=e("uYHD"),Ki=e("SspJ"),Yi=e("U2xU"),Xi=e("lAaw"),Zi=e("1ArG");const it=[{path:":courseId/:cmId",redirectTo:":courseId/:cmId/page/root"},{path:":courseId/:cmId/page/:hash",component:n.a},{path:":courseId/:cmId/edit",component:N,canDeactivate:[r.a]}];let tt=(()=>{class AddonModWikiLazyModule{}return AddonModWikiLazyModule.ɵmod=y.wc({type:AddonModWikiLazyModule}),AddonModWikiLazyModule.ɵinj=y.vc({factory:function AddonModWikiLazyModule_Factory(i){return new(i||AddonModWikiLazyModule)},imports:[[o.m.forChild(it),a.a,d.a,s.a]]}),AddonModWikiLazyModule})();void(("undefined"==typeof ngJitMode||ngJitMode)&&y.kd(tt,{declarations:[n.a,N],imports:[o.m,a.a,d.a,s.a]})),y.jd(n.a,[o.n,o.j,o.l,o.k,o.p,x.q,x.r,x.s,x.t,x.A,x.w,x.x,x.y,x.z,x.u,x.v,S.a,V.a,z.a,j.a,J.a,R.a,Q.a,H.a,G.a,B.a,$.a,q.a,U.a,K.a,Y.a,X.a,Z.a,C.a,ii.a,ti.a,ei.a,oi.a,ai.a,di.a,ni.a,si.a,ri.a,ci.a,li.a,hi.a,gi.a,ui.a,Ii.a,mi.a,pi.a,ki.a,wi.a,bi.a,fi.a,Ei.a,Pi.a,vi.a,_i.a,yi.a,Mi.a,Ti.a,Ai.a,Di.a,A.a,Li.a,Ci.a,xi.a,Fi.a,Wi.a,Oi.a,Ni.a,Si.b,Vi.a,zi.a,ji.a,L.a,D.a,Ji.a,M.H,M.w,M.G,M.c,M.x,M.A,M.a,M.D,M.E,M.z,M.r,M.s,M.C,M.o,M.n,M.y,M.b,M.d,M.u,M.v,M.t,T.f,T.g,T.h,T.j,T.k,T.l,T.m,T.n,T.o,T.p,T.q,T.r,T.s,T.t,T.u,T.v,T.w,T.x,T.y,T.z,T.A,T.B,T.C,T.D,T.E,T.F,T.G,T.H,T.I,T.J,T.K,T.L,T.M,T.N,T.O,T.P,T.Q,T.R,T.S,T.T,T.U,T.V,T.W,T.X,T.Y,T.Z,T.ab,T.bb,T.cb,T.db,T.eb,T.fb,T.hb,T.ib,T.jb,T.kb,T.lb,T.mb,T.nb,T.ob,T.pb,T.qb,T.rb,T.sb,T.tb,T.vb,T.wb,T.xb,T.zb,T.Ab,T.yb,T.ub,T.d,T.Jb,T.Mb,T.Ob,T.Pb,T.gb,T.i,T.Hb,T.Nb,T.Rb,T.Sb,T.Tb,T.Bb,M.h,M.k,M.i,M.l,M.e,W.a,Ri.a,Qi.a,Hi.a,F.a,n.a,N],[x.b,x.G,x.p,x.k,x.E,x.g,x.C,x.F,x.d,x.f,x.i,x.j,x.l,Gi.a,Bi.a,$i.a,qi.a,Ui.a,Ki.a,Yi.a,Xi.a,Zi.a,W.d])}}]);