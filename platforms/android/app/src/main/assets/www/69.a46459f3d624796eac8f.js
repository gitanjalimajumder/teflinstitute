(window.webpackJsonp=window.webpackJsonp||[]).push([[69],{Iaui:function(e,s,o){"use strict";o.r(s),o.d(s,"AddonModWorkshopLazyModule",(function(){return fs}));var t=o("tyNb"),i=o("MLi9"),a=o("L3Fv"),n=o("ghUQ"),d=o("pHTc"),r=o("20uA"),c=o("fXoL"),l=o("TEn/"),h=o("4JiN"),m=o("hMzs"),u=o("nt/U"),p=o("sYmb");let g=(()=>{class AddonModWorkshopIndexPage extends n.a{constructor(){super(...arguments),this.selectedGroup=0}ngOnInit(){super.ngOnInit(),this.selectedGroup=d.a.getRouteNumberParam("group")||0}}return AddonModWorkshopIndexPage.ɵfac=function AddonModWorkshopIndexPage_Factory(e){return f(e||AddonModWorkshopIndexPage)},AddonModWorkshopIndexPage.ɵcmp=c.sc({type:AddonModWorkshopIndexPage,selectors:[["page-addon-mod-workshop-index"]],viewQuery:function AddonModWorkshopIndexPage_Query(e,s){var o;(1&e&&c.ud(r.AddonModWorkshopIndexComponent,!0),2&e)&&(c.dd(o=c.Nc())&&(s.activityComponent=o.first))},features:[c.ic],decls:14,vars:13,consts:[["collapsible",""],["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end"],[1,"limited-width"],["slot","fixed",3,"disabled","ionRefresh"],[3,"pullingText"],[3,"module","courseId","group","dataRetrieved"]],template:function AddonModWorkshopIndexPage_Template(e,s){1&e&&(c.Ec(0,"ion-header",0),c.Ec(1,"ion-toolbar"),c.Ec(2,"ion-buttons",1),c.zc(3,"ion-back-button",2),c.Pc(4,"translate"),c.Dc(),c.Ec(5,"ion-title"),c.Ec(6,"h1"),c.zc(7,"core-format-text",3),c.Dc(),c.Dc(),c.zc(8,"ion-buttons",4),c.Dc(),c.Dc(),c.Ec(9,"ion-content",5),c.Ec(10,"ion-refresher",6),c.Mc("ionRefresh",(function AddonModWorkshopIndexPage_Template_ion_refresher_ionRefresh_10_listener(e){return null==s.activityComponent?null:s.activityComponent.doRefresh(e.target)})),c.zc(11,"ion-refresher-content",7),c.Pc(12,"translate"),c.Dc(),c.Ec(13,"addon-mod-workshop-index",8),c.Mc("dataRetrieved",(function AddonModWorkshopIndexPage_Template_addon_mod_workshop_index_dataRetrieved_13_listener(e){return s.updateData(e)})),c.Dc(),c.Dc()),2&e&&(c.lc(3),c.Vc("text",c.Qc(4,9,"core.back")),c.lc(4),c.Vc("text",s.title)("contextInstanceId",s.module.id)("courseId",s.courseId),c.lc(3),c.Vc("disabled",null==s.activityComponent?null:s.activityComponent.showLoading),c.lc(1),c.Wc("pullingText",c.Qc(12,11,"core.pulltorefresh")),c.lc(2),c.Vc("module",s.module)("courseId",s.courseId)("group",s.selectedGroup))},directives:[l.C,h.b,l.Ab,l.m,l.h,l.i,l.yb,m.a,u.a,l.v,l.bb,l.cb,r.AddonModWorkshopIndexComponent],pipes:[p.d],encapsulation:2}),AddonModWorkshopIndexPage})();const f=c.Gc(g);var _=o("Ie1r"),k=o("WoAp"),b=o("ekpb"),v=o("mrSG"),I=o("3Pt+"),A=o("ULAo"),w=o("FvYb"),M=o("4pns"),E=o("9+EE"),P=o("uT8i"),y=o("3LXp"),W=o("vuGA"),D=o("j3ag"),x=o("fjkH"),S=o("4reR"),T=o("i1f9"),O=o("8/zp"),F=o("EyWp"),V=o("GuJL"),C=o("8vmT"),L=o("D7J2"),R=o("DJrq"),q=o("ACYt"),G=o("ofXK"),Q=o("PgjG"),z=o("FeAf"),N=o("Lkkz"),U=o("FasJ"),H=o("N5Lt");const j=["evaluateFormEl"];function AddonModWorkshopAssessmentPage_ion_refresher_13_Template(e,s){if(1&e){const e=c.Fc();c.Ec(0,"ion-refresher",15),c.Mc("ionRefresh",(function AddonModWorkshopAssessmentPage_ion_refresher_13_Template_ion_refresher_ionRefresh_0_listener(s){c.fd(e);return c.Oc().refreshAssessment(s.target)})),c.zc(1,"ion-refresher-content",16),c.Pc(2,"translate"),c.Dc()}if(2&e){const e=c.Oc();c.Vc("disabled",!e.loaded),c.lc(1),c.Wc("pullingText",c.Qc(2,2,"core.pulltorefresh"))}}function AddonModWorkshopAssessmentPage_core_user_avatar_16_Template(e,s){if(1&e&&c.zc(0,"core-user-avatar",17),2&e){const e=c.Oc();c.Vc("user",e.profile)("courseId",e.courseId)("userId",e.profile.id)}}function AddonModWorkshopAssessmentPage_h2_18_Template(e,s){if(1&e&&(c.Ec(0,"h2"),c.pd(1),c.Dc()),2&e){const e=c.Oc();c.lc(1),c.qd(e.profile.fullname)}}const _c1=function(e){return{$a:e}};function AddonModWorkshopAssessmentPage_p_19_Template(e,s){if(1&e&&(c.Ec(0,"p"),c.pd(1),c.Pc(2,"translate"),c.Dc()),2&e){const e=c.Oc();c.lc(1),c.sd(" ",c.Rc(2,2,"addon.mod_workshop.submissiongradeof",c.ad(5,_c1,e.workshop.grade)),": ",e.assessment.grade," ")}}function AddonModWorkshopAssessmentPage_p_20_Template(e,s){if(1&e&&(c.Ec(0,"p"),c.pd(1),c.Pc(2,"translate"),c.Dc()),2&e){const e=c.Oc();c.qc("core-has-overriden-grade",e.showGrade(e.assessment.gradinggrade)),c.lc(1),c.sd(" ",c.Rc(2,4,"addon.mod_workshop.gradinggradeof",c.ad(7,_c1,e.workshop.gradinggrade)),": ",e.assessment.gradinggrade," ")}}function AddonModWorkshopAssessmentPage_p_21_Template(e,s){if(1&e&&(c.Ec(0,"p",18),c.pd(1),c.Pc(2,"translate"),c.Dc()),2&e){const e=c.Oc();c.lc(1),c.sd(" ",c.Qc(2,2,"addon.mod_workshop.gradinggradeover"),": ",e.assessment.gradinggradeover," ")}}function AddonModWorkshopAssessmentPage_p_22_Template(e,s){if(1&e&&(c.Ec(0,"p"),c.pd(1),c.Pc(2,"translate"),c.Dc()),2&e){const e=c.Oc();c.lc(1),c.rd(" ",c.Rc(2,1,"addon.mod_workshop.weightinfo",c.ad(4,_c1,e.assessment.weight))," ")}}function AddonModWorkshopAssessmentPage_ion_badge_23_Template(e,s){1&e&&(c.Ec(0,"ion-badge",19),c.pd(1),c.Pc(2,"translate"),c.Dc()),2&e&&(c.lc(1),c.rd(" ",c.Qc(2,1,"addon.mod_workshop.notassessed")," "))}function AddonModWorkshopAssessmentPage_addon_mod_workshop_assessment_strategy_24_Template(e,s){if(1&e&&c.zc(0,"addon-mod-workshop-assessment-strategy",20),2&e){const e=c.Oc();c.Vc("workshop",e.workshop)("access",e.access)("assessmentId",e.assessmentId)("userId",e.profile&&e.profile.id)("strategy",e.strategy)}}function AddonModWorkshopAssessmentPage_form_25_ion_item_7_ion_select_option_8_Template(e,s){if(1&e&&(c.Ec(0,"ion-select-option",29),c.pd(1),c.Dc()),2&e){const e=s.$implicit;c.Vc("value",e),c.lc(1),c.qd(e)}}const _c2=function(e){return{header:e}};function AddonModWorkshopAssessmentPage_form_25_ion_item_7_Template(e,s){if(1&e&&(c.Ec(0,"ion-item",7),c.Ec(1,"ion-label",25),c.Ec(2,"span",26),c.pd(3),c.Pc(4,"translate"),c.Dc(),c.Dc(),c.Ec(5,"ion-select",27),c.Pc(6,"translate"),c.Pc(7,"translate"),c.nd(8,AddonModWorkshopAssessmentPage_form_25_ion_item_7_ion_select_option_8_Template,2,2,"ion-select-option",28),c.Dc(),c.Dc()),2&e){const e=c.Oc(2);c.lc(3),c.rd(" ",c.Qc(4,4,"addon.mod_workshop.assessmentweight")," "),c.lc(2),c.Vc("cancelText",c.Qc(6,6,"core.cancel"))("interfaceOptions",c.ad(10,_c2,c.Qc(7,8,"addon.mod_workshop.assessmentweight"))),c.lc(3),c.Vc("ngForOf",e.weights)}}function AddonModWorkshopAssessmentPage_form_25_ion_item_15_ion_select_option_7_Template(e,s){if(1&e&&(c.Ec(0,"ion-select-option",29),c.pd(1),c.Dc()),2&e){const e=s.$implicit;c.Vc("value",e.value),c.lc(1),c.rd(" ",e.label," ")}}function AddonModWorkshopAssessmentPage_form_25_ion_item_15_Template(e,s){if(1&e&&(c.Ec(0,"ion-item",7),c.Ec(1,"ion-label",25),c.pd(2),c.Pc(3,"translate"),c.Dc(),c.Ec(4,"ion-select",30),c.Pc(5,"translate"),c.Pc(6,"translate"),c.nd(7,AddonModWorkshopAssessmentPage_form_25_ion_item_15_ion_select_option_7_Template,2,2,"ion-select-option",28),c.Dc(),c.Dc()),2&e){const e=c.Oc(2);c.lc(2),c.qd(c.Qc(3,4,"addon.mod_workshop.gradinggradeover")),c.lc(2),c.Vc("cancelText",c.Qc(5,6,"core.cancel"))("interfaceOptions",c.ad(10,_c2,c.Qc(6,8,"addon.mod_workshop.gradinggradeover"))),c.lc(3),c.Vc("ngForOf",e.evaluationGrades)}}const _c3=function(e){return{asid:e}};function AddonModWorkshopAssessmentPage_form_25_ion_item_16_Template(e,s){if(1&e&&(c.Ec(0,"ion-item"),c.Ec(1,"ion-label",25),c.pd(2),c.Pc(3,"translate"),c.Dc(),c.zc(4,"core-rich-text-editor",31),c.Dc()),2&e){const e=c.Oc(2);c.lc(2),c.qd(c.Qc(3,5,"addon.mod_workshop.feedbackreviewer")),c.lc(2),c.Vc("control",e.evaluateForm.controls.text)("autoSave",!0)("contextInstanceId",null==e.workshop?null:e.workshop.coursemodule)("draftExtraParams",c.ad(7,_c3,e.assessmentId))}}function AddonModWorkshopAssessmentPage_form_25_Template(e,s){if(1&e&&(c.Ec(0,"form",21,22),c.Ec(2,"ion-item",7),c.Ec(3,"ion-label"),c.Ec(4,"h3",23),c.pd(5),c.Pc(6,"translate"),c.Dc(),c.Dc(),c.Dc(),c.nd(7,AddonModWorkshopAssessmentPage_form_25_ion_item_7_Template,9,12,"ion-item",24),c.Ec(8,"ion-item",7),c.Ec(9,"ion-label"),c.Ec(10,"h3",23),c.pd(11),c.Pc(12,"translate"),c.Dc(),c.Ec(13,"p"),c.pd(14),c.Dc(),c.Dc(),c.Dc(),c.nd(15,AddonModWorkshopAssessmentPage_form_25_ion_item_15_Template,8,12,"ion-item",24),c.nd(16,AddonModWorkshopAssessmentPage_form_25_ion_item_16_Template,5,9,"ion-item",9),c.Dc()),2&e){const e=c.Oc();c.Vc("formGroup",e.evaluateForm),c.lc(5),c.qd(c.Qc(6,7,"addon.mod_workshop.assessmentsettings")),c.lc(2),c.Vc("ngIf",null==e.access?null:e.access.canallocate),c.lc(4),c.qd(c.Qc(12,9,"addon.mod_workshop.gradinggradecalculated")),c.lc(3),c.qd(e.gradingGrade),c.lc(1),c.Vc("ngIf",null==e.access?null:e.access.canoverridegrades),c.lc(1),c.Vc("ngIf",null==e.access?null:e.access.canoverridegrades)}}function AddonModWorkshopAssessmentPage_ion_list_26_core_user_avatar_2_Template(e,s){if(1&e&&c.zc(0,"core-user-avatar",17),2&e){const e=c.Oc(2);c.Vc("user",e.evaluateByProfile)("courseId",e.courseId)("userId",e.evaluateByProfile.id)}}function AddonModWorkshopAssessmentPage_ion_list_26_h3_4_Template(e,s){if(1&e&&(c.Ec(0,"h3",23),c.pd(1),c.Pc(2,"translate"),c.Dc()),2&e){const e=c.Oc(2);c.lc(1),c.rd(" ",c.Rc(2,1,"addon.mod_workshop.feedbackby",c.ad(4,_c1,e.evaluateByProfile.fullname))," ")}}function AddonModWorkshopAssessmentPage_ion_list_26_Template(e,s){if(1&e&&(c.Ec(0,"ion-list"),c.Ec(1,"ion-item",7),c.nd(2,AddonModWorkshopAssessmentPage_ion_list_26_core_user_avatar_2_Template,1,3,"core-user-avatar",8),c.Ec(3,"ion-label"),c.nd(4,AddonModWorkshopAssessmentPage_ion_list_26_h3_4_Template,3,6,"h3",32),c.zc(5,"core-format-text",2),c.Dc(),c.Dc(),c.Dc()),2&e){const e=c.Oc();c.lc(2),c.Vc("ngIf",e.evaluateByProfile),c.lc(2),c.Vc("ngIf",e.evaluateByProfile&&e.evaluateByProfile.fullname),c.lc(1),c.Vc("text",e.evaluate.text)("contextInstanceId",null==e.workshop?null:e.workshop.coursemodule)("courseId",e.courseId)}}let B=(()=>{class AddonModWorkshopAssessmentPage{constructor(e){this.fb=e,this.evaluating=!1,this.loaded=!1,this.title="",this.evaluate={text:"",grade:-1,weight:1},this.weights=[],this.evaluationGrades=[],this.originalEvaluation={text:"",grade:-1,weight:1},this.hasOffline=!1,this.isDestroyed=!1,this.forceLeave=!1,this.siteId=E.b.getCurrentSiteId(),this.currentUserId=E.b.getCurrentSiteUserId(),this.showGrade=O.AddonModWorkshopHelper.showGrade,this.evaluateForm=new I.j({}),this.evaluateForm.addControl("weight",this.fb.control("",I.F.required)),this.evaluateForm.addControl("grade",this.fb.control("")),this.evaluateForm.addControl("text",this.fb.control("")),this.syncObserver=x.b.on(V.AddonModWorkshopSyncProvider.AUTO_SYNCED,(e=>{this.workshopId===e.workshopId&&(this.loaded=!1,this.refreshAllData())}),this.siteId),this.logView=C.a.once((()=>Object(v.a)(this,void 0,void 0,(function*(){this.workshop&&L.a.logEvent({type:L.b.VIEW_ITEM,ws:"mod_workshop_get_assessment",name:this.workshop.name,data:{id:this.workshop.id,assessmentid:this.assessment.id,category:"workshop"},url:`/mod/workshop/assessment.php?asid=${this.assessment.id}`})}))))}ngOnInit(){try{this.assessment=d.a.getRequiredRouteParam("assessment"),this.submission=d.a.getRequiredRouteParam("submission"),this.profile=d.a.getRouteParam("profile"),this.courseId=d.a.getRequiredRouteNumberParam("courseId")}catch(e){return y.a.showErrorModal(e),d.a.back(),void 0}this.assessmentId=this.assessment.id,this.workshopId=this.submission.workshopid,this.fetchAssessmentData()}canLeave(){return Object(v.a)(this,void 0,void 0,(function*(){return!(!this.forceLeave&&this.evaluating)||(!this.hasEvaluationChanged()||(yield y.a.showConfirm(D.I.instant("core.confirmcanceledit")),S.a.triggerFormCancelledEvent(this.formElement,this.siteId),!0))}))}fetchAssessmentData(){var e,s;return Object(v.a)(this,void 0,void 0,(function*(){try{this.workshop=yield T.AddonModWorkshop.getWorkshopById(this.courseId,this.workshopId),this.title=this.workshop.name,this.strategy=this.workshop.strategy;const o=yield A.a.getModuleBasicGradeInfo(this.workshop.coursemodule);if(this.maxGrade=null==o?void 0:o.grade,this.access=yield T.AddonModWorkshop.getWorkshopAccessInformation(this.workshopId,{cmId:this.workshop.coursemodule}),this.assessmentId&&(this.access.canallocate||this.access.canoverridegrades)?(this.isDestroyed||P.a.blockOperation(R.a,this.workshopId),this.evaluating=!0):this.evaluating=!1,!this.evaluating&&this.workshop.phase!=T.AddonModWorkshopPhase.PHASE_CLOSED)return;const t=yield O.AddonModWorkshopHelper.getReviewerAssessmentById(this.workshopId,this.assessmentId,{userId:null===(e=this.profile)||void 0===e?void 0:e.id,cmId:this.workshop.coursemodule});if(this.assessment=O.AddonModWorkshopHelper.realGradeValue(this.workshop,t),this.evaluate.text=this.assessment.feedbackreviewer||"",this.evaluate.weight=this.assessment.weight,this.gradingGrade=null!==(s=this.assessment.gradinggrade)&&void 0!==s?s:"-",this.evaluating){if(this.access.canallocate){this.weights=[];for(let e=16;e>=0;e--)this.weights[e]=e}if(this.access.canoverridegrades){const e=D.I.instant("addon.mod_workshop.notoverridden");this.evaluationGrades=yield w.a.makeGradesMenu(this.workshop.gradinggrade,void 0,e,-1)}try{const e=yield F.AddonModWorkshopOffline.getEvaluateAssessment(this.workshopId,this.assessmentId);this.hasOffline=!0,this.evaluate.weight=e.weight,this.access.canoverridegrades&&(this.evaluate.text=e.feedbacktext||"",this.evaluate.grade=parseInt(e.gradinggradeover,10)||-1)}catch(e){this.hasOffline=!1,this.access.canoverridegrades&&(this.evaluate.text=this.assessment.feedbackreviewer||"",this.evaluate.grade=parseInt(String(this.assessment.gradinggradeover),10)||-1)}finally{this.originalEvaluation.weight=this.evaluate.weight,this.access.canoverridegrades&&(this.originalEvaluation.text=this.evaluate.text,this.originalEvaluation.grade=this.evaluate.grade),this.evaluateForm.controls.weight.setValue(this.evaluate.weight),this.access.canoverridegrades&&(this.evaluateForm.controls.grade.setValue(this.evaluate.grade),this.evaluateForm.controls.text.setValue(this.evaluate.text))}}else this.workshop.phase==T.AddonModWorkshopPhase.PHASE_CLOSED&&this.assessment.gradinggradeoverby&&(this.evaluateByProfile=yield M.a.getProfile(this.assessment.gradinggradeoverby,this.courseId,!0))}catch(e){y.a.showErrorModalDefault(e,"mm.course.errorgetmodule",!0)}finally{this.loaded=!0}}))}forceLeavePage(){this.forceLeave=!0,d.a.back()}hasEvaluationChanged(){if(!this.loaded||!this.evaluating)return!1;const e=this.evaluateForm.value;if(this.originalEvaluation.weight!=e.weight)return!0;if(this.access&&this.access.canoverridegrades){if(this.originalEvaluation.text!=e.text)return!0;if(this.originalEvaluation.grade!=e.grade)return!0}return!1}refreshAllData(){return Object(v.a)(this,void 0,void 0,(function*(){const e=[];e.push(T.AddonModWorkshop.invalidateWorkshopData(this.courseId)),e.push(T.AddonModWorkshop.invalidateWorkshopAccessInformationData(this.workshopId)),e.push(T.AddonModWorkshop.invalidateReviewerAssesmentsData(this.workshopId)),this.assessmentId&&(e.push(T.AddonModWorkshop.invalidateAssessmentFormData(this.workshopId,this.assessmentId)),e.push(T.AddonModWorkshop.invalidateAssessmentData(this.workshopId,this.assessmentId)));try{yield Promise.all(e)}finally{x.b.trigger(T.AddonModWorkshopProvider.ASSESSMENT_INVALIDATED,null,this.siteId),yield this.fetchAssessmentData()}}))}refreshAssessment(e){this.loaded&&this.refreshAllData().finally((()=>{null==e?void 0:e.complete()}))}saveEvaluation(){return Object(v.a)(this,void 0,void 0,(function*(){this.hasEvaluationChanged()&&(yield this.sendEvaluation()),this.forceLeavePage()}))}sendEvaluation(){return Object(v.a)(this,void 0,void 0,(function*(){const e=yield y.a.showModalLoading("core.sending",!0),s=this.evaluateForm.value,o=s.grade>=0?String(s.grade):"",t=W.b.formatHtmlLines(s.text);try{const e=yield T.AddonModWorkshop.evaluateAssessment(this.workshopId,this.assessmentId,this.courseId,t,s.weight,o);S.a.triggerFormSubmittedEvent(this.formElement,!!e,this.siteId);const i={workshopId:this.workshopId,assessmentId:this.assessmentId,userId:this.currentUserId};return T.AddonModWorkshop.invalidateAssessmentData(this.workshopId,this.assessmentId).finally((()=>{x.b.trigger(T.AddonModWorkshopProvider.ASSESSMENT_SAVED,i,this.siteId)}))}catch(e){y.a.showErrorModalDefault(e,"Cannot save assessment evaluation")}finally{e.dismiss()}}))}ngOnDestroy(){var e;this.isDestroyed=!0,null===(e=this.syncObserver)||void 0===e||e.off(),P.a.unblockOperation(R.a,this.workshopId)}}return AddonModWorkshopAssessmentPage.ɵfac=function AddonModWorkshopAssessmentPage_Factory(e){return new(e||AddonModWorkshopAssessmentPage)(c.yc(I.f))},AddonModWorkshopAssessmentPage.ɵcmp=c.sc({type:AddonModWorkshopAssessmentPage,selectors:[["page-addon-mod-workshop-assessment-page"]],viewQuery:function AddonModWorkshopAssessmentPage_Query(e,s){var o;(1&e&&c.ud(j,!0),2&e)&&(c.dd(o=c.Nc())&&(s.formElement=o.first))},decls:27,vars:22,consts:[["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end",3,"hidden"],["fill","clear",3,"click"],["slot","fixed",3,"disabled","ionRefresh",4,"ngIf"],[3,"hideUntil"],[1,"ion-text-wrap"],["slot","start",3,"user","courseId","userId",4,"ngIf"],[4,"ngIf"],[3,"core-has-overriden-grade",4,"ngIf"],["class","core-overriden-grade",4,"ngIf"],["color","danger",4,"ngIf"],[3,"workshop","access","assessmentId","userId","strategy",4,"ngIf"],[3,"formGroup",4,"ngIf"],["slot","fixed",3,"disabled","ionRefresh"],[3,"pullingText"],["slot","start",3,"user","courseId","userId"],[1,"core-overriden-grade"],["color","danger"],[3,"workshop","access","assessmentId","userId","strategy"],[3,"formGroup"],["evaluateFormEl",""],[1,"item-heading"],["class","ion-text-wrap",4,"ngIf"],["position","stacked"],["core-mark-required","true"],["formControlName","weight","required","true","interface","action-sheet",3,"cancelText","interfaceOptions"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["formControlName","grade","interface","action-sheet",3,"cancelText","interfaceOptions"],["name","text","contextLevel","module","elementId","feedbackreviewer_editor",3,"control","autoSave","contextInstanceId","draftExtraParams"],["class","item-heading",4,"ngIf"]],template:function AddonModWorkshopAssessmentPage_Template(e,s){1&e&&(c.Ec(0,"ion-header"),c.Ec(1,"ion-toolbar"),c.Ec(2,"ion-buttons",0),c.zc(3,"ion-back-button",1),c.Pc(4,"translate"),c.Dc(),c.Ec(5,"ion-title"),c.Ec(6,"h1"),c.zc(7,"core-format-text",2),c.Dc(),c.Dc(),c.Ec(8,"ion-buttons",3),c.Ec(9,"ion-button",4),c.Mc("click",(function AddonModWorkshopAssessmentPage_Template_ion_button_click_9_listener(){return s.saveEvaluation()})),c.pd(10),c.Pc(11,"translate"),c.Dc(),c.Dc(),c.Dc(),c.Dc(),c.Ec(12,"ion-content"),c.nd(13,AddonModWorkshopAssessmentPage_ion_refresher_13_Template,3,4,"ion-refresher",5),c.Ec(14,"core-loading",6),c.Ec(15,"ion-item",7),c.nd(16,AddonModWorkshopAssessmentPage_core_user_avatar_16_Template,1,3,"core-user-avatar",8),c.Ec(17,"ion-label"),c.nd(18,AddonModWorkshopAssessmentPage_h2_18_Template,2,1,"h2",9),c.nd(19,AddonModWorkshopAssessmentPage_p_19_Template,3,7,"p",9),c.nd(20,AddonModWorkshopAssessmentPage_p_20_Template,3,9,"p",10),c.nd(21,AddonModWorkshopAssessmentPage_p_21_Template,3,4,"p",11),c.nd(22,AddonModWorkshopAssessmentPage_p_22_Template,3,6,"p",9),c.nd(23,AddonModWorkshopAssessmentPage_ion_badge_23_Template,3,3,"ion-badge",12),c.Dc(),c.Dc(),c.nd(24,AddonModWorkshopAssessmentPage_addon_mod_workshop_assessment_strategy_24_Template,1,5,"addon-mod-workshop-assessment-strategy",13),c.nd(25,AddonModWorkshopAssessmentPage_form_25_Template,17,11,"form",14),c.nd(26,AddonModWorkshopAssessmentPage_ion_list_26_Template,6,5,"ion-list",9),c.Dc(),c.Dc()),2&e&&(c.lc(3),c.Vc("text",c.Qc(4,18,"core.back")),c.lc(4),c.Vc("text",s.title)("contextInstanceId",s.workshop&&s.workshop.coursemodule)("courseId",s.courseId),c.lc(1),c.Vc("hidden",!s.evaluating),c.lc(2),c.rd(" ",c.Qc(11,20,"core.save")," "),c.lc(3),c.Vc("ngIf",!s.evaluating),c.lc(1),c.Vc("hideUntil",s.loaded),c.lc(2),c.Vc("ngIf",s.profile),c.lc(2),c.Vc("ngIf",s.profile&&s.profile.fullname),c.lc(1),c.Vc("ngIf",s.workshop&&s.assessment&&s.showGrade(s.assessment.grade)),c.lc(1),c.Vc("ngIf",s.workshop&&s.access&&s.access.canviewallsubmissions&&s.assessment&&s.showGrade(s.assessment.gradinggrade)),c.lc(1),c.Vc("ngIf",s.access&&s.access.canviewallsubmissions&&s.assessment&&s.showGrade(s.assessment.gradinggradeover)),c.lc(1),c.Vc("ngIf",s.assessment&&s.assessment.weight&&1!=s.assessment.weight),c.lc(1),c.Vc("ngIf",!s.assessment||!s.showGrade(s.assessment.grade)),c.lc(1),c.Vc("ngIf",s.assessment&&s.assessmentId&&s.showGrade(s.assessment.grade)&&s.workshop&&s.access),c.lc(1),c.Vc("ngIf",s.evaluating),c.lc(1),c.Vc("ngIf",!s.evaluating&&s.evaluate&&s.evaluate.text))},directives:[l.C,l.Ab,l.m,l.h,l.i,l.yb,m.a,q.a,l.l,u.a,l.v,G.t,Q.a,l.I,l.O,l.bb,l.cb,z.a,l.k,N.a,I.H,I.s,I.k,U.a,l.lb,l.Ob,I.r,I.i,I.C,G.s,l.mb,H.a,l.P],pipes:[p.d],encapsulation:2}),AddonModWorkshopAssessmentPage})();var J=o("93ts"),Y=o("hSQQ"),K=o("EmGO"),$=o("L2dF"),X=o("bFG1"),Z=o("M9y5");const ee=["editFormEl"];function AddonModWorkshopEditSubmissionPage_form_16_ion_item_9_Template(e,s){if(1&e&&(c.Ec(0,"ion-item"),c.Ec(1,"ion-label",9),c.Ec(2,"span",14),c.pd(3),c.Pc(4,"translate"),c.Dc(),c.Dc(),c.zc(5,"core-rich-text-editor",15),c.Pc(6,"translate"),c.Dc()),2&e){const e=c.Oc(2);c.lc(2),c.Vc("core-mark-required",e.textRequired),c.lc(1),c.rd(" ",c.Qc(4,9,"addon.mod_workshop.submissioncontent")," "),c.lc(2),c.Vc("control",e.editForm.controls.content)("placeholder",c.Qc(6,11,"addon.mod_workshop.submissioncontent"))("component",e.component)("componentId",e.componentId)("autoSave",!0)("contextInstanceId",e.module.id)("draftExtraParams",e.editorExtraParams)}}function AddonModWorkshopEditSubmissionPage_form_16_core_attachments_10_Template(e,s){if(1&e&&c.zc(0,"core-attachments",16),2&e){const e=c.Oc(2);c.Vc("files",e.attachments)("maxSize",e.workshop.maxbytes)("maxSubmissions",e.workshop.nattachments)("component",e.component)("componentId",e.workshop.coursemodule)("acceptedTypes",e.workshop.submissionfiletypes)("required",e.fileRequired)("courseId",e.workshop.course)}}function AddonModWorkshopEditSubmissionPage_form_16_Template(e,s){if(1&e&&(c.Ec(0,"form",6,7),c.Ec(2,"ion-item",8),c.Ec(3,"ion-label",9),c.Ec(4,"span",10),c.pd(5),c.Pc(6,"translate"),c.Dc(),c.Dc(),c.zc(7,"ion-input",11),c.Pc(8,"translate"),c.Dc(),c.nd(9,AddonModWorkshopEditSubmissionPage_form_16_ion_item_9_Template,7,13,"ion-item",12),c.nd(10,AddonModWorkshopEditSubmissionPage_form_16_core_attachments_10_Template,1,8,"core-attachments",13),c.Dc()),2&e){const e=c.Oc();c.Vc("formGroup",e.editForm),c.lc(5),c.rd(" ",c.Qc(6,5,"addon.mod_workshop.submissiontitle")," "),c.lc(2),c.Vc("placeholder",c.Qc(8,7,"addon.mod_workshop.submissiontitle")),c.lc(2),c.Vc("ngIf",e.textAvailable),c.lc(1),c.Vc("ngIf",e.fileAvailable)}}let se=(()=>{class AddonModWorkshopEditSubmissionPage{constructor(e){this.fb=e,this.loaded=!1,this.component=R.a,this.editorExtraParams={},this.textAvailable=!1,this.textRequired=!1,this.fileAvailable=!1,this.fileRequired=!1,this.attachments=[],this.submissionId=0,this.originalData={title:"",content:"",attachmentfiles:[]},this.hasOffline=!1,this.editing=!1,this.forceLeave=!1,this.isDestroyed=!1,this.userId=E.b.getCurrentSiteUserId(),this.siteId=E.b.getCurrentSiteId(),this.editForm=new I.j({}),this.editForm.addControl("title",this.fb.control("",I.F.required)),this.editForm.addControl("content",this.fb.control(""))}ngOnInit(){try{this.module=d.a.getRequiredRouteParam("module"),this.courseId=d.a.getRequiredRouteNumberParam("courseId"),this.access=d.a.getRequiredRouteParam("access"),this.submissionId=d.a.getRouteNumberParam("submissionId")||0}catch(e){return y.a.showErrorModal(e),d.a.back(),void 0}this.submissionId>0&&(this.editorExtraParams.id=this.submissionId),this.workshopId=this.module.instance,this.componentId=this.module.id,this.isDestroyed||P.a.blockOperation(this.component,this.workshopId),this.fetchSubmissionData()}canLeave(){var e;return Object(v.a)(this,void 0,void 0,(function*(){return this.forceLeave||(this.hasDataChanged()&&(yield y.a.showConfirm(D.I.instant("core.confirmcanceledit"))),(null===(e=this.submission)||void 0===e?void 0:e.attachmentfiles)&&Y.a.clearTmpFiles(this.submission.attachmentfiles),S.a.triggerFormCancelledEvent(this.formElement,this.siteId)),!0}))}fetchSubmissionData(){return Object(v.a)(this,void 0,void 0,(function*(){try{if(this.workshop=yield T.AddonModWorkshop.getWorkshop(this.courseId,this.module.id),this.textAvailable=this.workshop.submissiontypetext!=T.AddonModWorkshopSubmissionType.SUBMISSION_TYPE_DISABLED,this.textRequired=this.workshop.submissiontypetext==T.AddonModWorkshopSubmissionType.SUBMISSION_TYPE_REQUIRED,this.fileAvailable=this.workshop.submissiontypefile!=T.AddonModWorkshopSubmissionType.SUBMISSION_TYPE_DISABLED,this.fileRequired=this.workshop.submissiontypefile==T.AddonModWorkshopSubmissionType.SUBMISSION_TYPE_REQUIRED,this.editForm.controls.content.setValidators(this.textRequired?I.F.required:null),this.submissionId>0){this.editing=!0,this.submission=yield O.AddonModWorkshopHelper.getSubmissionById(this.workshopId,this.submissionId,{cmId:this.module.id});if(!(this.userId==this.submission.authorid&&this.access.cansubmit&&this.access.modifyingsubmissionallowed))return this.forceLeavePage(),void 0}else if(!this.access.cansubmit||!this.access.creatingsubmissionallowed)return this.forceLeavePage(),void 0;const e=yield F.AddonModWorkshopOffline.getSubmissions(this.workshopId);e&&e.length?(this.hasOffline=!0,this.submission=yield O.AddonModWorkshopHelper.applyOfflineData(this.submission,e)):this.hasOffline=!1,this.submission&&(this.originalData.title=this.submission.title||"",this.originalData.content=this.submission.content||"",this.originalData.attachmentfiles=[],(this.submission.attachmentfiles||[]).forEach((e=>{let s=K.a.getFileName(e);s||(s=$.a.getFilenameFromPath(e)||""),this.originalData.attachmentfiles.push({filename:s,fileurl:"fileurl"in e?e.fileurl:""})})),this.editForm.controls.title.setValue(this.submission.title),this.editForm.controls.content.setValue(this.submission.content),this.attachments=this.submission.attachmentfiles||[]),this.loaded=!0,this.logView()}catch(e){this.loaded=!1,y.a.showErrorModalDefault(e,"core.course.errorgetmodule",!0),this.forceLeavePage()}}))}logView(){this.workshop&&L.a.logEvent({type:L.b.VIEW_ITEM,ws:this.editing?"mod_workshop_update_submission":"mod_workshop_add_submission",name:this.workshop.name,data:{id:this.workshop.id,submissionid:this.submissionId,category:"workshop"},url:`/mod/workshop/submission.php?cmid=${this.module.id}&id=${this.submissionId}&edit=on`})}forceLeavePage(){this.forceLeave=!0,d.a.back()}getInputData(){const e={title:this.editForm.value.title,content:"",attachmentfiles:[]};return this.textAvailable&&(e.content=this.editForm.value.content||""),this.fileAvailable&&(e.attachmentfiles=this.attachments),e}hasDataChanged(){if(!this.loaded)return!1;const e=this.getInputData();return!!(this.originalData.title!=e.title||this.textAvailable&&this.originalData.content!=e.content)||!!this.fileAvailable&&Y.a.areFileListDifferent(e.attachmentfiles,this.originalData.attachmentfiles)}save(){return Object(v.a)(this,void 0,void 0,(function*(){if(this.hasDataChanged())try{yield this.saveSubmission(),this.forceLeavePage()}catch(e){}else this.forceLeavePage()}))}saveSubmission(){var e;return Object(v.a)(this,void 0,void 0,(function*(){const s=this.getInputData();if(!s.title)throw y.a.showAlertTranslated("core.notice","addon.mod_workshop.submissionrequiredtitle"),new J.a(D.I.instant("addon.mod_workshop.submissionrequiredtitle"));const o=W.b.htmlIsBlank(s.content),t=!s.attachmentfiles.length;if(this.textRequired&&o||this.fileRequired&&t||o&&t)throw y.a.showAlertTranslated("core.notice","addon.mod_workshop.submissionrequiredcontent"),new J.a(D.I.instant("addon.mod_workshop.submissionrequiredcontent"));let i=!1;const a=yield y.a.showModalLoading("core.sending",!0),n=null===(e=this.submission)||void 0===e?void 0:e.id;this.textAvailable&&(s.content=W.b.formatHtmlLines(s.content));let d=!s.attachmentfiles.length;try{let e,o,t;try{e=yield O.AddonModWorkshopHelper.uploadOrStoreSubmissionFiles(this.workshopId,s.attachmentfiles,!1)}catch(e){if(X.a.isWebServiceError(e))throw e;i=!0,d=!0,o=yield O.AddonModWorkshopHelper.uploadOrStoreSubmissionFiles(this.workshopId,s.attachmentfiles,!0)}if(i||this.fileAvailable||(e=void 0),this.editing)if(i)yield F.AddonModWorkshopOffline.saveSubmission(this.workshopId,this.courseId,s.title,s.content,o,n,T.AddonModWorkshopAction.UPDATE),t=!1;else{if(!n)throw new J.a("Submission cannot be updated without a submissionId");t=yield T.AddonModWorkshop.updateSubmission(this.workshopId,n,this.courseId,s.title,s.content,e,void 0,d)}else i?(yield F.AddonModWorkshopOffline.saveSubmission(this.workshopId,this.courseId,s.title,s.content,o,void 0,T.AddonModWorkshopAction.ADD),t=!1):t=yield T.AddonModWorkshop.addSubmission(this.workshopId,this.courseId,s.title,s.content,e,void 0,d);S.a.triggerFormSubmittedEvent(this.formElement,!!t,this.siteId);const a={workshopId:this.workshopId};t&&(F.AddonModWorkshopOffline.deleteSubmissionAction(this.workshopId,this.editing?T.AddonModWorkshopAction.UPDATE:T.AddonModWorkshopAction.ADD),O.AddonModWorkshopHelper.deleteSubmissionStoredFiles(this.workshopId,this.siteId),a.submissionId=t),x.b.trigger(x.b.ACTIVITY_DATA_SENT,{module:"workshop"});const r=t?T.AddonModWorkshop.invalidateSubmissionData(this.workshopId,t):Promise.resolve();yield r.finally((()=>{x.b.trigger(T.AddonModWorkshopProvider.SUBMISSION_CHANGED,a,this.siteId),Y.a.clearTmpFiles(s.attachmentfiles)}))}catch(e){y.a.showErrorModalDefault(e,"Cannot save submission")}finally{a.dismiss()}}))}getFilesComponentId(){return this.workshopId+"_"+(this.submissionId>0?this.submissionId:"newsub")}ngOnDestroy(){this.isDestroyed=!0,P.a.unblockOperation(this.component,this.workshopId)}}return AddonModWorkshopEditSubmissionPage.ɵfac=function AddonModWorkshopEditSubmissionPage_Factory(e){return new(e||AddonModWorkshopEditSubmissionPage)(c.yc(I.f))},AddonModWorkshopEditSubmissionPage.ɵcmp=c.sc({type:AddonModWorkshopEditSubmissionPage,selectors:[["page-addon-mod-workshop-edit-submission"]],viewQuery:function AddonModWorkshopEditSubmissionPage_Query(e,s){var o;(1&e&&c.ud(ee,!0),2&e)&&(c.dd(o=c.Nc())&&(s.formElement=o.first))},decls:17,vars:14,consts:[["slot","start"],[3,"text"],["slot","end"],["fill","clear",3,"click"],[3,"hideUntil"],[3,"formGroup",4,"ngIf"],[3,"formGroup"],["editFormEl",""],[1,"ion-text-wrap"],["position","stacked"],["core-mark-required","true"],["name","title","type","text","formControlName","title",3,"placeholder"],[4,"ngIf"],["allowOffline","true",3,"files","maxSize","maxSubmissions","component","componentId","acceptedTypes","required","courseId",4,"ngIf"],[3,"core-mark-required"],["name","content","contextLevel","module","elementId","content_editor",3,"control","placeholder","component","componentId","autoSave","contextInstanceId","draftExtraParams"],["allowOffline","true",3,"files","maxSize","maxSubmissions","component","componentId","acceptedTypes","required","courseId"]],template:function AddonModWorkshopEditSubmissionPage_Template(e,s){1&e&&(c.Ec(0,"ion-header"),c.Ec(1,"ion-toolbar"),c.Ec(2,"ion-buttons",0),c.zc(3,"ion-back-button",1),c.Pc(4,"translate"),c.Dc(),c.Ec(5,"ion-title"),c.Ec(6,"h1"),c.pd(7),c.Pc(8,"translate"),c.Dc(),c.Dc(),c.Ec(9,"ion-buttons",2),c.Ec(10,"ion-button",3),c.Mc("click",(function AddonModWorkshopEditSubmissionPage_Template_ion_button_click_10_listener(){return s.save()})),c.Pc(11,"translate"),c.pd(12),c.Pc(13,"translate"),c.Dc(),c.Dc(),c.Dc(),c.Dc(),c.Ec(14,"ion-content"),c.Ec(15,"core-loading",4),c.nd(16,AddonModWorkshopEditSubmissionPage_form_16_Template,11,9,"form",5),c.Dc(),c.Dc()),2&e&&(c.lc(3),c.Vc("text",c.Qc(4,6,"core.back")),c.lc(4),c.qd(c.Qc(8,8,"addon.mod_workshop.editsubmission")),c.lc(3),c.mc("aria-label",c.Qc(11,10,"core.save")),c.lc(2),c.rd(" ",c.Qc(13,12,"core.save")," "),c.lc(3),c.Vc("hideUntil",s.loaded),c.lc(1),c.Vc("ngIf",s.workshop))},directives:[l.C,l.Ab,l.m,l.h,l.i,l.yb,q.a,l.l,u.a,l.v,Q.a,G.t,I.H,I.s,I.k,l.I,l.O,U.a,l.H,l.Pb,I.r,I.i,H.a,Z.a],pipes:[p.d],encapsulation:2}),AddonModWorkshopEditSubmissionPage})();var oe=o("aEIl"),te=o("3zv0"),ie=o("Lmwl"),ae=o("4qNr"),ne=o("fQ68"),de=o("8/N+"),re=o("0QZc"),ce=o("uHIS"),le=o("w+Pn"),he=o("r8G5"),me=o("5450"),ue=o("W5pS"),pe=o("WPIK"),ge=o("qNqN"),fe=o("xpMl"),_e=o("FTxb"),ke=o("/K1O"),be=o("9pYf"),ve=o("eAud"),Ie=o("ACV2"),Ae=o("/BoF"),we=o("TKc2"),Me=o("whRm"),Ee=o("O4u7"),Pe=o("lqoc"),ye=o("3lz8"),We=o("46ml"),De=o("QQhE"),xe=o("MpCO"),Se=o("JYLr"),Te=o("vWwc"),Oe=o("NhJP"),Fe=o("rztj"),Ve=o("rf3J"),Ce=o("nEkO"),Le=o("TF0o"),Re=o("p5uK"),qe=o("ijlo"),Ge=o("vFDU"),Qe=o("6uVz"),ze=o("d0nH"),Ne=o("NcPy"),Ue=o("yNDK"),He=o("3CSS"),je=o("iSJP"),Be=o("iJls"),Je=o("ArDJ"),Ye=o("nu3w"),Ke=o("saTE"),$e=o("8PoL"),Xe=o("4a38"),Ze=o("OZH1"),es=o("edOc"),ss=o("3jOR"),os=o("6A9T"),ts=o("Uzd6"),is=o("0w4i"),as=o("G92Y"),ns=o("1iFe"),ds=o("dne1"),rs=o("Cg42"),cs=o("llyR"),ls=o("uYHD"),hs=o("SspJ"),ms=o("U2xU"),us=o("lAaw"),ps=o("1ArG");const gs=[{path:":courseId/:cmId",component:g},{path:":courseId/:cmId/:submissionId",component:k.a,canDeactivate:[i.a]},{path:":courseId/:cmId/:submissionId/edit",component:se,canDeactivate:[i.a]},{path:":courseId/:cmId/:submissionId/:assessmentId",component:B,canDeactivate:[i.a]}];let fs=(()=>{class AddonModWorkshopLazyModule{}return AddonModWorkshopLazyModule.ɵmod=c.wc({type:AddonModWorkshopLazyModule}),AddonModWorkshopLazyModule.ɵinj=c.vc({factory:function AddonModWorkshopLazyModule_Factory(e){return new(e||AddonModWorkshopLazyModule)},imports:[[t.m.forChild(gs),a.a,_.AddonModWorkshopComponentsModule,b.a]]}),AddonModWorkshopLazyModule})();void(("undefined"==typeof ngJitMode||ngJitMode)&&c.kd(fs,{declarations:[g,k.a,B,se],imports:[t.m,a.a,_.AddonModWorkshopComponentsModule,b.a]})),c.jd(k.a,[t.n,t.j,t.l,t.k,t.p,G.q,G.r,G.s,G.t,G.A,G.w,G.x,G.y,G.z,G.u,G.v,Z.a,oe.a,te.a,ie.a,ae.a,ne.a,de.a,re.a,ce.a,le.a,he.a,me.a,ue.a,pe.a,ge.a,fe.a,_e.a,Q.a,ke.a,U.a,be.a,ve.a,Ie.a,Ae.a,we.a,Me.a,Ee.a,Pe.a,ye.a,We.a,De.a,xe.a,Se.a,Te.a,Oe.a,Fe.a,z.a,Ve.a,Ce.a,Le.a,Re.a,qe.a,Ge.a,Qe.a,ze.a,Ne.a,Ue.a,He.a,m.a,je.a,Be.a,Je.a,Ye.a,Ke.a,$e.a,Xe.a,h.b,Ze.a,es.a,ss.a,u.a,q.a,os.a,I.H,I.w,I.G,I.c,I.x,I.A,I.a,I.D,I.E,I.z,I.r,I.s,I.C,I.o,I.n,I.y,I.b,I.d,I.u,I.v,I.t,l.f,l.g,l.h,l.j,l.k,l.l,l.m,l.n,l.o,l.p,l.q,l.r,l.s,l.t,l.u,l.v,l.w,l.x,l.y,l.z,l.A,l.B,l.C,l.D,l.E,l.F,l.G,l.H,l.I,l.J,l.K,l.L,l.M,l.N,l.O,l.P,l.Q,l.R,l.S,l.T,l.U,l.V,l.W,l.X,l.Y,l.Z,l.ab,l.bb,l.cb,l.db,l.eb,l.fb,l.hb,l.ib,l.jb,l.kb,l.lb,l.mb,l.nb,l.ob,l.pb,l.qb,l.rb,l.sb,l.tb,l.vb,l.wb,l.xb,l.zb,l.Ab,l.yb,l.ub,l.d,l.Jb,l.Mb,l.Ob,l.Pb,l.gb,l.i,l.Hb,l.Nb,l.Rb,l.Sb,l.Tb,l.Bb,I.h,I.k,I.i,I.l,I.e,p.a,r.AddonModWorkshopIndexComponent,ts.a,is.a,as.a,N.a,H.a,g,k.a,B,se],[G.b,G.G,G.p,G.k,G.E,G.g,G.C,G.F,G.d,G.f,G.i,G.j,G.l,ns.a,ds.a,rs.a,cs.a,ls.a,hs.a,ms.a,us.a,ps.a,p.d])}}]);