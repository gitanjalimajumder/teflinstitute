(window.webpackJsonp=window.webpackJsonp||[]).push([[75],{iETG:function(e,t,n){"use strict";n.r(t),n.d(t,"CoreCommentsLazyModule",(function(){return F}));var o=n("L3Fv"),s=n("tyNb"),i=n("mrSG"),c=n("fjkH"),a=n("9+EE"),r=n("5pQw"),m=n("kQNd"),l=n("TEn/"),d=n("BaYo"),h=n("pHTc"),u=n("j3ag"),f=n("bFG1"),g=n("3LXp"),C=n("4pns"),_=n("vuGA"),p=n("93ts"),I=n("rdx0"),v=n("Q98t"),b=n("nvXB"),D=n("GGba"),w=n("f0Wu"),y=n.n(w),O=n("MUy3"),P=n("fXoL"),x=n("hMzs"),L=n("ofXK"),M=n("fQ68"),E=n("8/N+"),V=n("nt/U"),N=n("PgjG"),T=n("xpMl"),A=n("ACYt"),k=n("3CSS"),S=n("r8G5"),U=n("9pYf"),z=n("O4u7"),j=n("sYmb"),G=n("uYHD");function CoreCommentsViewerPage_ion_button_9_Template(e,t){if(1&e){const e=P.Fc();P.Ec(0,"ion-button",16),P.Mc("click",(function CoreCommentsViewerPage_ion_button_9_Template_ion_button_click_0_listener(){P.fd(e);return P.Oc().toggleDelete()})),P.Pc(1,"translate"),P.zc(2,"ion-icon",17),P.Dc()}2&e&&P.mc("aria-label",P.Qc(1,1,"core.toggledelete"))}function CoreCommentsViewerPage_core_empty_box_20_Template(e,t){1&e&&(P.zc(0,"core-empty-box",18),P.Pc(1,"translate")),2&e&&P.Vc("message",P.Qc(1,1,"core.comments.nocomments"))}function CoreCommentsViewerPage_ng_container_23_p_1_Template(e,t){if(1&e&&(P.Ec(0,"p",21),P.pd(1),P.Pc(2,"coreFormatDate"),P.Dc()),2&e){const e=P.Oc().$implicit;P.lc(1),P.rd(" ",P.Rc(2,1,1e3*e.timecreated,"strftimedayshort")," ")}}function CoreCommentsViewerPage_ng_container_23_Template(e,t){if(1&e){const e=P.Fc();P.Cc(0),P.nd(1,CoreCommentsViewerPage_ng_container_23_p_1_Template,3,4,"p",19),P.Ec(2,"core-message",20),P.Mc("onDeleteMessage",(function CoreCommentsViewerPage_ng_container_23_Template_core_message_onDeleteMessage_2_listener(){P.fd(e);const n=t.$implicit;return P.Oc().deleteComment(n)}))("onUndoDeleteMessage",(function CoreCommentsViewerPage_ng_container_23_Template_core_message_onUndoDeleteMessage_2_listener(){P.fd(e);const n=t.$implicit;return P.Oc().undoDeleteComment(n)})),P.Dc(),P.Bc()}if(2&e){const e=t.$implicit,n=P.Oc();P.lc(1),P.Vc("ngIf",e.showDate),P.lc(1),P.Vc("message",e)("text",e.content)("time",1e3*e.timecreated)("user",e)("showDelete",n.showDelete)("contextLevel",n.contextLevel)("instanceId",n.instanceId)("courseId",n.courseId)}}const _c0=function(e){return{$a:e}};function CoreCommentsViewerPage_ion_badge_24_Template(e,t){1&e&&(P.Ec(0,"ion-badge",22),P.zc(1,"ion-icon",23),P.pd(2),P.Pc(3,"translate"),P.Pc(4,"lowercase"),P.Pc(5,"translate"),P.Dc()),2&e&&(P.lc(2),P.rd(" ",P.Rc(3,1,"core.thereisdatatosync",P.ad(8,_c0,P.Qc(4,4,P.Qc(5,6,"core.comments.comments"))))," "))}function CoreCommentsViewerPage_core_message_25_Template(e,t){if(1&e){const e=P.Fc();P.Ec(0,"core-message",24),P.Mc("onDeleteMessage",(function CoreCommentsViewerPage_core_message_25_Template_core_message_onDeleteMessage_0_listener(){P.fd(e);const t=P.Oc();return t.deleteComment(t.offlineComment)})),P.Dc()}if(2&e){const e=P.Oc();P.Vc("message",e.offlineComment)("text",e.offlineComment.content)("user",e.offlineComment)("showDelete",e.showDelete)("contextLevel",e.contextLevel)("instanceId",e.instanceId)("courseId",e.courseId)}}function CoreCommentsViewerPage_ion_footer_26_Template(e,t){if(1&e){const e=P.Fc();P.Ec(0,"ion-footer",25),P.Ec(1,"ion-toolbar"),P.Ec(2,"core-send-message-form",26),P.Mc("onSubmit",(function CoreCommentsViewerPage_ion_footer_26_Template_core_send_message_form_onSubmit_2_listener(t){P.fd(e);return P.Oc().addComment(t)})),P.Pc(3,"translate"),P.Dc(),P.Dc(),P.Dc()}if(2&e){const e=P.Oc();P.lc(2),P.Vc("sendDisabled",e.sending)("message",e.newComment)("placeholder",P.Qc(3,3,"core.comments.addcomment"))}}let R=(()=>{class CoreCommentsViewerPage{constructor(e){this.route=e,this.comments=[],this.commentsLoaded=!1,this.itemId=0,this.area="",this.page=0,this.title="",this.canLoadMore=!1,this.loadMoreError=!1,this.canAddComments=!1,this.canDeleteComments=!1,this.showDelete=!1,this.hasOffline=!1,this.refreshIcon=d.a.ICON_LOADING,this.syncIcon=d.a.ICON_LOADING,this.sending=!1,this.newComment="",this.addDeleteCommentsAvailable=!1,this.viewDestroyed=!1,this.currentUserId=a.b.getCurrentSiteUserId(),this.syncObserver=c.b.on(m.b.AUTO_SYNCED,(e=>{e.contextLevel==this.contextLevel&&e.instanceId==this.instanceId&&e.componentName==this.componentName&&e.itemId==this.itemId&&e.area==this.area&&(this.showSyncWarnings(e.warnings),this.commentsLoaded=!1,this.refreshIcon=d.a.ICON_LOADING,this.syncIcon=d.a.ICON_LOADING,this.page=0,this.comments=[],this.fetchComments(!1))}),a.b.getCurrentSiteId()),this.isOnline=D.a.isOnline(),this.onlineObserver=D.a.onChange().subscribe((()=>{u.z.run((()=>{this.isOnline=D.a.isOnline()}))}))}ngOnInit(){return Object(i.a)(this,void 0,void 0,(function*(){try{this.contextLevel=h.a.getRequiredRouteParam("contextLevel"),this.instanceId=h.a.getRequiredRouteNumberParam("instanceId"),this.componentName=h.a.getRequiredRouteParam("componentName"),this.itemId=h.a.getRequiredRouteNumberParam("itemId"),this.area=h.a.getRouteParam("area")||"",this.title=h.a.getRouteParam("title")||u.I.instant("core.comments.comments"),this.courseId=h.a.getRouteNumberParam("courseId")}catch(e){return g.a.showErrorModal(e),h.a.back(),void 0}this.addDeleteCommentsAvailable=yield r.a.isAddCommentsAvailable(),this.currentUserId=a.b.getCurrentSiteUserId(),this.commentsLoaded=!1,yield this.fetchComments(!0)}))}fetchComments(e,t=!1){return Object(i.a)(this,void 0,void 0,(function*(){this.loadMoreError=!1,e&&(yield f.a.ignoreErrors(this.syncComments(t)));try{const e=yield r.a.getComments(this.contextLevel,this.instanceId,this.componentName,this.itemId,this.area,this.page);this.canAddComments=this.addDeleteCommentsAvailable&&!!e.canpost;let t=e.comments.sort(((e,t)=>e.timecreated-t.timecreated));this.canLoadMore=void 0!==e.count?this.comments.length+t.length<e.count:e.comments.length>0&&e.comments.length>=r.b.pageSize,t=yield Promise.all(t.map((e=>this.loadCommentProfile(e)))),this.comments=t.concat(this.comments),this.comments.forEach(((e,t)=>this.calculateCommentData(e,this.comments[t-1]))),this.canDeleteComments=this.addDeleteCommentsAvailable&&(this.hasOffline||this.comments.some((e=>!!e.delete))),yield this.loadOfflineData()}catch(e){this.loadMoreError=!0,e&&"assignsubmission_comments"==this.componentName?g.a.showAlertTranslated("core.notice","core.comments.commentsnotworking"):g.a.showErrorModalDefault(e,u.I.instant("core.error")+": get_comments")}finally{this.commentsLoaded=!0,this.refreshIcon=d.a.ICON_REFRESH,this.syncIcon=d.a.ICON_SYNC,0==this.page&&this.scrollToBottom()}}))}calculateCommentData(e,t){e.showDate=this.showDate(e,t),e.showUserData=this.showUserData(e,t),e.showTail=this.showTail(e,t)}loadPrevious(e){return Object(i.a)(this,void 0,void 0,(function*(){this.page++,this.canLoadMore=!1;try{yield this.fetchComments(!0)}finally{e&&e()}}))}refreshComments(e,t){return Object(i.a)(this,void 0,void 0,(function*(){this.commentsLoaded=!1,this.refreshIcon=d.a.ICON_LOADING,this.syncIcon=d.a.ICON_LOADING,yield f.a.ignoreErrors(this.invalidateComments()),this.page=0,this.comments=[];try{yield this.fetchComments(!0,e)}finally{null==t?void 0:t.complete()}}))}showSyncWarnings(e){const t=_.b.buildMessage(e);t&&g.a.showAlert(void 0,t)}syncComments(e){return Object(i.a)(this,void 0,void 0,(function*(){try{const e=yield m.a.syncComments(this.contextLevel,this.instanceId,this.componentName,this.itemId,this.area);this.showSyncWarnings((null==e?void 0:e.warnings)||[])}catch(t){throw e&&g.a.showErrorModalDefault(t,"core.errorsync",!0),new p.a(t)}}))}addComment(e){return Object(i.a)(this,void 0,void 0,(function*(){b.a.closeKeyboard();const t=yield g.a.showModalLoading("core.sending",!0);this.sending=!0;try{const t=yield r.a.addComment(e,this.contextLevel,this.instanceId,this.componentName,this.itemId,this.area);if(g.a.showToast(t?"core.comments.eventcommentcreated":"core.datastoredoffline",!0,g.c.LONG),t){this.invalidateComments();const e=yield this.loadCommentProfile(t);this.calculateCommentData(e,this.comments[this.comments.length-1]),this.comments=this.comments.concat([e]),this.canDeleteComments=this.addDeleteCommentsAvailable,c.b.trigger(r.b.COMMENTS_COUNT_CHANGED_EVENT,{contextLevel:this.contextLevel,instanceId:this.instanceId,component:this.componentName,itemId:this.itemId,area:this.area,countChange:1},a.b.getCurrentSiteId()),this.refreshInBackground()}else!1===t&&(yield this.loadOfflineData())}catch(e){g.a.showErrorModal(e)}finally{t.dismiss(),this.sending=!1,this.scrollToBottom()}}))}deleteComment(e){return Object(i.a)(this,void 0,void 0,(function*(){const t=v.a.userDate(1e3*("lastmodified"in e?e.lastmodified:e.timecreated),"core.strftimerecentfull"),n={contextlevel:this.contextLevel,instanceid:this.instanceId,component:this.componentName,itemid:this.itemId,area:this.area,content:e.content,id:"id"in e?e.id:void 0};try{yield g.a.showDeleteConfirm("core.comments.deletecommentbyon",{$a:{user:e.fullname||"",time:t}})}catch(e){return}try{const t=yield r.a.deleteComment(n);if(this.showDelete=!1,t&&"id"in e){const t=this.comments.findIndex((t=>t.id==e.id));t>=0&&(this.comments.splice(t,1),c.b.trigger(r.b.COMMENTS_COUNT_CHANGED_EVENT,{contextLevel:this.contextLevel,instanceId:this.instanceId,component:this.componentName,itemId:this.itemId,area:this.area,countChange:-1},a.b.getCurrentSiteId()),this.refreshInBackground())}else this.loadOfflineData();this.invalidateComments(),g.a.showToast("core.comments.eventcommentdeleted",!0,g.c.LONG)}catch(e){g.a.showErrorModalDefault(e,"Delete comment failed.")}}))}invalidateComments(){return r.a.invalidateCommentsData(this.contextLevel,this.instanceId,this.componentName,this.itemId,this.area)}loadCommentProfile(e){return Object(i.a)(this,void 0,void 0,(function*(){if(!e.userid)return e;try{const t=yield C.a.getProfile(e.userid,void 0,!0);e.profileimageurl=t.profileimageurl,e.fullname=t.fullname}catch(e){}return e}))}showUserData(e,t){return!(e.userid==this.currentUserId||t&&t.userid==e.userid&&!e.showDate)}showTail(e,t){return!t||t.userid!=e.userid||!!t.showDate}showDate(e,t){return!t||!y()(1e3*e.timecreated).isSame(1e3*t.timecreated,"day")}loadOfflineData(){return Object(i.a)(this,void 0,void 0,(function*(){const e=[];let t=!1;e.push(I.a.getComment(this.contextLevel,this.instanceId,this.componentName,this.itemId,this.area).then((e=>Object(i.a)(this,void 0,void 0,(function*(){this.offlineComment=e,this.offlineComment&&(""==this.newComment&&(this.newComment=this.offlineComment.content),this.offlineComment.userid=this.currentUserId,this.offlineComment.pending=!0)}))))),e.push(I.a.getDeletedComments(this.contextLevel,this.instanceId,this.componentName,this.itemId,this.area).then((e=>{t=e&&e.length>0,t&&e.forEach((e=>{const t=this.comments.find((t=>t.id==e.commentid));t&&(t.deleted=!!e.deleted)}))}))),yield Promise.all(e),this.hasOffline=!!this.offlineComment||t}))}undoDeleteComment(e){return Object(i.a)(this,void 0,void 0,(function*(){yield I.a.undoDeleteComment(e.id),e.deleted=!1,this.showDelete=!1}))}scrollToBottom(){setTimeout((()=>{var e;this.viewDestroyed||(null===(e=this.content)||void 0===e?void 0:e.scrollToBottom())}),100)}toggleDelete(){this.showDelete=!this.showDelete}refreshInBackground(){return Object(i.a)(this,void 0,void 0,(function*(){yield f.a.ignoreErrors(this.invalidateComments());const e=[];for(let t=0;t<=this.page;t++)e.push(r.a.getComments(this.contextLevel,this.instanceId,this.componentName,this.itemId,this.area,t));yield Promise.all(e)}))}ngOnDestroy(){var e;null===(e=this.syncObserver)||void 0===e?void 0:e.off(),this.onlineObserver.unsubscribe(),this.viewDestroyed=!0}}return CoreCommentsViewerPage.ɵfac=function CoreCommentsViewerPage_Factory(e){return new(e||CoreCommentsViewerPage)(P.yc(s.a))},CoreCommentsViewerPage.ɵcmp=P.sc({type:CoreCommentsViewerPage,selectors:[["page-core-comments-viewer"]],viewQuery:function CoreCommentsViewerPage_Query(e,t){var n;(1&e&&P.ud(l.v,!0),2&e)&&(P.dd(n=P.Nc())&&(t.content=n.first))},decls:27,vars:34,consts:[["slot","start"],[3,"text"],[3,"text","contextLevel","contextInstanceId","courseId"],["slot","end"],["slot","end","fill","clear",3,"click",4,"ngIf"],[3,"hidden","priority","content","iconAction","closeOnClick","action"],["slot","fixed",3,"disabled","ionRefresh"],[3,"pullingText"],[3,"hideUntil"],["icon","fas-comments",3,"message",4,"ngIf"],["position","top",3,"enabled","error","action"],[1,"addon-messages-discussion-container"],[4,"ngFor","ngForOf"],["class","ion-text-wrap","color","info",4,"ngIf"],[3,"message","text","user","showDelete","contextLevel","instanceId","courseId","onDeleteMessage",4,"ngIf"],["class","footer-adjustable",4,"ngIf"],["slot","end","fill","clear",3,"click"],["name","fas-pen","slot","icon-only","aria-hidden","true"],["icon","fas-comments",3,"message"],["class","ion-text-center addon-messages-date",4,"ngIf"],[3,"message","text","time","user","showDelete","contextLevel","instanceId","courseId","onDeleteMessage","onUndoDeleteMessage"],[1,"ion-text-center","addon-messages-date"],["color","info",1,"ion-text-wrap"],["name","fas-triangle-exclamation","aria-hidden","true"],[3,"message","text","user","showDelete","contextLevel","instanceId","courseId","onDeleteMessage"],[1,"footer-adjustable"],[3,"sendDisabled","message","placeholder","onSubmit"]],template:function CoreCommentsViewerPage_Template(e,t){1&e&&(P.Ec(0,"ion-header"),P.Ec(1,"ion-toolbar"),P.Ec(2,"ion-buttons",0),P.zc(3,"ion-back-button",1),P.Pc(4,"translate"),P.Dc(),P.Ec(5,"ion-title"),P.Ec(6,"h1"),P.zc(7,"core-format-text",2),P.Dc(),P.Dc(),P.Ec(8,"ion-buttons",3),P.nd(9,CoreCommentsViewerPage_ion_button_9_Template,3,3,"ion-button",4),P.Ec(10,"core-context-menu"),P.Ec(11,"core-context-menu-item",5),P.Mc("action",(function CoreCommentsViewerPage_Template_core_context_menu_item_action_11_listener(){return t.refreshComments(!1)})),P.Pc(12,"translate"),P.Dc(),P.Ec(13,"core-context-menu-item",5),P.Mc("action",(function CoreCommentsViewerPage_Template_core_context_menu_item_action_13_listener(){return t.refreshComments(!0)})),P.Pc(14,"translate"),P.Dc(),P.Dc(),P.Dc(),P.Dc(),P.Dc(),P.Ec(15,"ion-content"),P.Ec(16,"ion-refresher",6),P.Mc("ionRefresh",(function CoreCommentsViewerPage_Template_ion_refresher_ionRefresh_16_listener(e){return t.refreshComments(!1,e.target)})),P.zc(17,"ion-refresher-content",7),P.Pc(18,"translate"),P.Dc(),P.Ec(19,"core-loading",8),P.nd(20,CoreCommentsViewerPage_core_empty_box_20_Template,2,3,"core-empty-box",9),P.Ec(21,"core-infinite-loading",10),P.Mc("action",(function CoreCommentsViewerPage_Template_core_infinite_loading_action_21_listener(e){return t.loadPrevious(e)})),P.Dc(),P.Ec(22,"ion-list",11),P.nd(23,CoreCommentsViewerPage_ng_container_23_Template,3,9,"ng-container",12),P.nd(24,CoreCommentsViewerPage_ion_badge_24_Template,6,10,"ion-badge",13),P.nd(25,CoreCommentsViewerPage_core_message_25_Template,1,7,"core-message",14),P.Dc(),P.Dc(),P.Dc(),P.nd(26,CoreCommentsViewerPage_ion_footer_26_Template,4,5,"ion-footer",15)),2&e&&(P.lc(3),P.Vc("text",P.Qc(4,26,"core.back")),P.lc(4),P.Vc("text",t.title)("contextLevel",t.contextLevel)("contextInstanceId",t.instanceId)("courseId",t.courseId),P.lc(2),P.Vc("ngIf",t.canDeleteComments),P.lc(2),P.Vc("hidden",!(t.commentsLoaded&&!t.hasOffline))("priority",100)("content",P.Qc(12,28,"core.refresh"))("iconAction",t.refreshIcon)("closeOnClick",!0),P.lc(2),P.Vc("hidden",!(t.commentsLoaded&&t.hasOffline&&t.isOnline))("priority",100)("content",P.Qc(14,30,"core.settings.synchronizenow"))("iconAction",t.syncIcon)("closeOnClick",!1),P.lc(3),P.Vc("disabled",!t.commentsLoaded),P.lc(1),P.Wc("pullingText",P.Qc(18,32,"core.pulltorefresh")),P.lc(2),P.Vc("hideUntil",t.commentsLoaded),P.lc(1),P.Vc("ngIf",!(null!=t.comments&&t.comments.length||t.offlineComment)),P.lc(1),P.Vc("enabled",t.canLoadMore)("error",t.loadMoreError),P.lc(2),P.Vc("ngForOf",t.comments),P.lc(1),P.Vc("ngIf",t.hasOffline),P.lc(1),P.Vc("ngIf",t.hasOffline&&t.offlineComment),P.lc(1),P.Vc("ngIf",t.commentsLoaded&&t.canAddComments))},directives:[l.C,l.Ab,l.m,l.h,l.i,l.yb,x.a,L.t,M.a,E.a,V.a,l.v,l.bb,l.cb,N.a,T.a,l.P,L.s,A.a,l.l,l.D,k.a,S.a,U.a,l.k,l.A,z.a],pipes:[j.d,G.a,L.p],styles:[".ios[_nghost-%COMP%]   ion-footer[_ngcontent-%COMP%]   .toolbar[_ngcontent-%COMP%]:last-child, .ios   [_nghost-%COMP%]   ion-footer[_ngcontent-%COMP%]   .toolbar[_ngcontent-%COMP%]:last-child{padding-bottom:4px;min-height:0}ion-content[_ngcontent-%COMP%]{--content-background:var(--background-alternative);--background:var(--content-background)}ion-content[_ngcontent-%COMP%]::part(scroll){padding-bottom:0!important}.addon-messages-discussion-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding-bottom:16px!important;background:var(--content-background)}.addon-messages-date[_ngcontent-%COMP%]{font-weight:400;font-size:.9rem}ion-badge[_ngcontent-%COMP%]{margin:8px auto}"],data:{animation:[O.a.SLIDE_IN_OUT]}}),CoreCommentsViewerPage})();const Q=[{path:":contextLevel/:instanceId/:componentName/:itemId",component:R}];let F=(()=>{class CoreCommentsLazyModule{}return CoreCommentsLazyModule.ɵmod=P.wc({type:CoreCommentsLazyModule}),CoreCommentsLazyModule.ɵinj=P.vc({factory:function CoreCommentsLazyModule_Factory(e){return new(e||CoreCommentsLazyModule)},imports:[[s.m.forChild(Q),o.a]]}),CoreCommentsLazyModule})();void(("undefined"==typeof ngJitMode||ngJitMode)&&P.kd(F,{declarations:[R],imports:[s.m,o.a]}))}}]);