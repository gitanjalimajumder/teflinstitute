(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{"8IdJ":function(o,e,t){"use strict";t.r(e),t.d(e,"AddonModBookLazyModule",(function(){return J}));var n=t("tyNb"),a=t("L3Fv"),d=t("JktO"),i=t("ghUQ"),c=t("x+LU"),s=t("fXoL"),r=t("TEn/"),l=t("4JiN"),u=t("hMzs"),h=t("nt/U"),m=t("sYmb");let g=(()=>{class AddonModBookIndexPage extends i.a{}return AddonModBookIndexPage.ɵfac=function AddonModBookIndexPage_Factory(o){return p(o||AddonModBookIndexPage)},AddonModBookIndexPage.ɵcmp=s.sc({type:AddonModBookIndexPage,selectors:[["page-addon-mod-book-index"]],viewQuery:function AddonModBookIndexPage_Query(o,e){var t;(1&o&&s.ud(c.a,!0),2&o)&&(s.dd(t=s.Nc())&&(e.activityComponent=t.first))},features:[s.ic],decls:14,vars:12,consts:[["collapsible",""],["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end"],[1,"limited-width"],["slot","fixed",3,"disabled","ionRefresh"],[3,"pullingText"],[3,"module","courseId","dataRetrieved"]],template:function AddonModBookIndexPage_Template(o,e){1&o&&(s.Ec(0,"ion-header",0),s.Ec(1,"ion-toolbar"),s.Ec(2,"ion-buttons",1),s.zc(3,"ion-back-button",2),s.Pc(4,"translate"),s.Dc(),s.Ec(5,"ion-title"),s.Ec(6,"h1"),s.zc(7,"core-format-text",3),s.Dc(),s.Dc(),s.zc(8,"ion-buttons",4),s.Dc(),s.Dc(),s.Ec(9,"ion-content",5),s.Ec(10,"ion-refresher",6),s.Mc("ionRefresh",(function AddonModBookIndexPage_Template_ion_refresher_ionRefresh_10_listener(o){return null==e.activityComponent?null:e.activityComponent.doRefresh(o.target)})),s.zc(11,"ion-refresher-content",7),s.Pc(12,"translate"),s.Dc(),s.Ec(13,"addon-mod-book-index",8),s.Mc("dataRetrieved",(function AddonModBookIndexPage_Template_addon_mod_book_index_dataRetrieved_13_listener(o){return e.updateData(o)})),s.Dc(),s.Dc()),2&o&&(s.lc(3),s.Vc("text",s.Qc(4,8,"core.back")),s.lc(4),s.Vc("text",e.title)("contextInstanceId",null==e.module?null:e.module.id)("courseId",e.courseId),s.lc(3),s.Vc("disabled",null==e.activityComponent?null:e.activityComponent.showLoading),s.lc(1),s.Wc("pullingText",s.Qc(12,10,"core.pulltorefresh")),s.lc(2),s.Vc("module",e.module)("courseId",e.courseId))},directives:[r.C,l.b,r.Ab,r.m,r.h,r.i,r.yb,u.a,h.a,r.v,r.bb,r.cb,c.a],pipes:[m.d],encapsulation:2}),AddonModBookIndexPage})();const p=s.Gc(g);var v=t("yQkb"),_=t("mrSG"),f=t("BaYo"),I=t("93ts"),b=t("kBKO"),M=t("qwWh"),k=t("MpCO"),C=t("ULAo"),y=t("zbKZ"),B=t("kWmn"),x=t("GGba"),A=t("pHTc"),P=t("3LXp"),E=t("vuGA"),D=t("bFG1"),w=t("j3ag"),O=t("Fb4V"),T=t("7ZBW"),L=t("D7J2"),S=t("mvS9"),R=t("ofXK"),V=t("PgjG"),z=t("ACYt"),N=t("3CSS"),U=t("vSVd"),j=t("/BoF"),Q=t("3jOR");function AddonModBookContentsPage_ion_button_9_Template(o,e){if(1&o){const o=s.Fc();s.Ec(0,"ion-button",12),s.Mc("click",(function AddonModBookContentsPage_ion_button_9_Template_ion_button_click_0_listener(){s.fd(o);return s.Oc().showToc()})),s.Pc(1,"translate"),s.zc(2,"ion-icon",13),s.Dc()}2&o&&s.mc("aria-label",s.Qc(1,1,"addon.mod_book.toc"))}function AddonModBookContentsPage_ion_card_16_Template(o,e){if(1&o&&(s.Ec(0,"ion-card",14),s.Ec(1,"ion-item"),s.zc(2,"ion-icon",15),s.Ec(3,"ion-label"),s.zc(4,"span",16),s.Dc(),s.Dc(),s.Dc()),2&o){const o=s.Oc();s.lc(4),s.Vc("innerHTML",o.warning,s.gd)}}function AddonModBookContentsPage_ng_template_18_div_2_Template(o,e){if(1&o&&(s.Ec(0,"div",20),s.Ec(1,"strong"),s.pd(2),s.Pc(3,"translate"),s.Dc(),s.zc(4,"core-tag-list",21),s.Dc()),2&o){const o=s.Oc().item;s.lc(2),s.rd("",s.Qc(3,2,"core.tag.tags"),": "),s.lc(2),s.Vc("tags",o.tags)}}function AddonModBookContentsPage_ng_template_18_Template(o,e){if(1&o&&(s.Ec(0,"div",17),s.zc(1,"core-format-text",18),s.nd(2,AddonModBookContentsPage_ng_template_18_div_2_Template,5,4,"div",19),s.Dc()),2&o){const o=e.item,t=e.active,n=s.Oc();s.lc(1),s.Vc("component",n.component)("componentId",n.cmId)("text",o.content)("contextInstanceId",n.cmId)("courseId",n.courseId)("disabled",!t),s.lc(1),s.Vc("ngIf",(null==o.tags?null:o.tags.length)>0)}}function AddonModBookContentsPage_core_navigation_bar_19_Template(o,e){if(1&o){const o=s.Fc();s.Ec(0,"core-navigation-bar",22),s.Mc("action",(function AddonModBookContentsPage_core_navigation_bar_19_Template_core_navigation_bar_action_0_listener(e){s.fd(o);return s.Oc().changeChapter(e.id)})),s.Dc()}if(2&o){const o=s.Oc();s.Vc("items",o.navigationItems)}}let F=(()=>{class AddonModBookContentsPage{constructor(){this.title="",this.component=T.b.COMPONENT,this.warning="",this.displayNavBar=!0,this.navigationItems=[],this.slidesOpts={autoHeight:!0,observer:!0,observeParents:!0,scrollOnChange:"top"},this.loaded=!1}ngOnInit(){try{this.cmId=A.a.getRequiredRouteNumberParam("cmId"),this.courseId=A.a.getRequiredRouteNumberParam("courseId"),this.initialChapterId=A.a.getRouteNumberParam("chapterId")}catch(o){return P.a.showErrorModal(o),A.a.back(),void 0}const o=new contents_AddonModBookSlidesItemsManagerSource(this.courseId,this.cmId,B.a.areTagsAvailableInSite(),this.initialChapterId);this.manager=new b.a(o),this.managerUnsubscribe=this.manager.addListener({onSelectedItemUpdated:o=>{this.onChapterViewed(o.id)}}),this.fetchContent()}get module(){var o;return null===(o=this.manager)||void 0===o?void 0:o.getSource().module}get book(){var o;return null===(o=this.manager)||void 0===o?void 0:o.getSource().book}get chapters(){var o;return(null===(o=this.manager)||void 0===o?void 0:o.getSource().chapters)||[]}fetchContent(o=!1){var e;return Object(_.a)(this,void 0,void 0,(function*(){try{const t=null===(e=this.manager)||void 0===e?void 0:e.getSource();if(!t)return;const{module:n,book:a}=yield t.loadBookData(),d=yield this.downloadResourceIfNeeded(n,o);if(this.displayNavBar=0!=a.navstyle,this.title=a.name,yield t.loadContents(),yield t.load(),null==d?void 0:d.failed){const o=E.b.getErrorMessageFromError(d.error)||d.error;this.warning=w.I.instant("core.errordownloadingsomefiles")+(o?" "+o:"")}else this.warning=""}catch(o){P.a.showErrorModalDefault(o,"core.course.errorgetmodule",!0)}finally{this.loaded=!0}}))}downloadResourceIfNeeded(o,e=!1){var t;return Object(_.a)(this,void 0,void 0,(function*(){const n={failed:!1};let a=!1;if((yield y.a.getModuleStatus(o,this.courseId,void 0,e))!==f.a.DOWNLOADED)try{yield y.a.downloadModule(o,this.courseId),a=!0}catch(o){n.failed=!0,n.error=o}if(!(null===(t=o.contents)||void 0===t?void 0:t.length)||e&&!a){const t=e&&x.a.isOnline();try{yield C.a.loadModuleContents(o,void 0,void 0,!1,t)}catch(e){if(t&&!o.contents)yield C.a.loadModuleContents(o);else if(!o.contents)throw e}}return n}))}changeChapter(o){var e;o&&(null===(e=this.slides)||void 0===e?void 0:e.slideToItem({id:o}))}doRefresh(o){return Object(_.a)(this,void 0,void 0,(function*(){this.manager&&(yield D.a.ignoreErrors(Promise.all([this.manager.getSource().invalidateContent(),y.a.invalidateCourseUpdates(this.courseId)]))),yield D.a.ignoreErrors(this.fetchContent(!0)),null==o||o.complete()}))}showToc(){var o;return Object(_.a)(this,void 0,void 0,(function*(){const e=null===(o=this.manager)||void 0===o?void 0:o.getSelectedItem(),t=yield P.a.openSideModal({component:O.a,componentProps:{moduleId:this.cmId,chapters:this.chapters,selected:null==e?void 0:e.id,courseId:this.courseId,book:this.book}});t&&this.changeChapter(t)}))}onChapterViewed(o){return Object(_.a)(this,void 0,void 0,(function*(){if(this.displayNavBar&&(this.navigationItems=this.getNavigationItems(o)),this.book&&T.a.storeLastChapterViewed(this.book.id,o,this.courseId),!this.module)return;yield D.a.ignoreErrors(T.a.logView(this.module.instance,o)),L.a.logEvent({type:L.b.VIEW_ITEM,ws:"mod_book_view_book",name:this.module.name,data:{id:this.module.instance,category:"book",chapterid:o},url:S.a.addParamsToUrl(`/mod/book/view.php?id=${this.module.id}`,{chapterid:o})});const e=this.chapters.findIndex((e=>e.id==o));(e<0||void 0===this.chapters[e+1])&&C.a.checkModuleCompletion(this.courseId,this.module.completiondata)}))}getNavigationItems(o){return this.chapters.map((e=>({item:e,title:e.title,current:e.id==o,enabled:!0})))}ngOnDestroy(){var o,e;null===(o=this.manager)||void 0===o?void 0:o.destroy(),null===(e=this.managerUnsubscribe)||void 0===e||e.call(this),delete this.manager}}return AddonModBookContentsPage.ɵfac=function AddonModBookContentsPage_Factory(o){return new(o||AddonModBookContentsPage)},AddonModBookContentsPage.ɵcmp=s.sc({type:AddonModBookContentsPage,selectors:[["page-addon-mod-book-contents"]],viewQuery:function AddonModBookContentsPage_Query(o,e){var t;(1&o&&s.ud(k.a,!0),2&o)&&(s.dd(t=s.Nc())&&(e.slides=t.first))},decls:20,vars:16,consts:[["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end"],["aria-haspopup","true",3,"click",4,"ngIf"],["slot","fixed",3,"disabled","ionRefresh"],[3,"pullingText"],[3,"hideUntil"],[1,"safe-area-padding-horizontal","core-swipe-slides-container"],["class","core-warning-card",4,"ngIf"],[3,"manager","options"],["collapsible-footer","","appearOnBottom","","previousTranslate","addon.mod_book.navprevtitle","nextTranslate","addon.mod_book.navnexttitle","slot","fixed",3,"items","action",4,"ngIf"],["aria-haspopup","true",3,"click"],["name","fas-bookmark","slot","icon-only","aria-hidden","true"],[1,"core-warning-card"],["name","fas-triangle-exclamation","slot","start","aria-hidden","true"],[3,"innerHTML"],[1,"ion-padding"],["contextLevel","module",3,"component","componentId","text","contextInstanceId","courseId","disabled"],["class","ion-margin-top",4,"ngIf"],[1,"ion-margin-top"],[3,"tags"],["collapsible-footer","","appearOnBottom","","previousTranslate","addon.mod_book.navprevtitle","nextTranslate","addon.mod_book.navnexttitle","slot","fixed",3,"items","action"]],template:function AddonModBookContentsPage_Template(o,e){1&o&&(s.Ec(0,"ion-header"),s.Ec(1,"ion-toolbar"),s.Ec(2,"ion-buttons",0),s.zc(3,"ion-back-button",1),s.Pc(4,"translate"),s.Dc(),s.Ec(5,"ion-title"),s.Ec(6,"h1"),s.zc(7,"core-format-text",2),s.Dc(),s.Dc(),s.Ec(8,"ion-buttons",3),s.nd(9,AddonModBookContentsPage_ion_button_9_Template,3,3,"ion-button",4),s.Dc(),s.Dc(),s.Dc(),s.Ec(10,"ion-content"),s.Ec(11,"ion-refresher",5),s.Mc("ionRefresh",(function AddonModBookContentsPage_Template_ion_refresher_ionRefresh_11_listener(o){return e.doRefresh(o.target)})),s.zc(12,"ion-refresher-content",6),s.Pc(13,"translate"),s.Dc(),s.Ec(14,"core-loading",7),s.Ec(15,"div",8),s.nd(16,AddonModBookContentsPage_ion_card_16_Template,5,1,"ion-card",9),s.Ec(17,"core-swipe-slides",10),s.nd(18,AddonModBookContentsPage_ng_template_18_Template,3,7,"ng-template"),s.Dc(),s.Dc(),s.Dc(),s.nd(19,AddonModBookContentsPage_core_navigation_bar_19_Template,1,1,"core-navigation-bar",11),s.Dc()),2&o&&(s.lc(3),s.Vc("text",s.Qc(4,12,"core.back")),s.lc(4),s.Vc("text",e.title)("contextInstanceId",e.cmId)("courseId",e.courseId),s.lc(2),s.Vc("ngIf",e.loaded),s.lc(2),s.Vc("disabled",!e.loaded),s.lc(1),s.Wc("pullingText",s.Qc(13,14,"core.pulltorefresh")),s.lc(2),s.Vc("hideUntil",e.loaded),s.lc(2),s.Vc("ngIf",e.warning),s.lc(1),s.Vc("manager",e.manager)("options",e.slidesOpts),s.lc(2),s.Vc("ngIf",e.loaded&&e.displayNavBar&&e.navigationItems.length>1))},directives:[r.C,r.Ab,r.m,r.h,r.i,r.yb,u.a,R.t,h.a,r.v,r.bb,r.cb,V.a,k.a,z.a,r.l,r.D,N.a,r.n,r.I,r.O,U.a,j.a,Q.a],pipes:[m.d],styles:["[_nghost-%COMP%]   .core-swipe-slides-container[_ngcontent-%COMP%]   ion-card[_ngcontent-%COMP%]{flex:none}"]}),AddonModBookContentsPage})();class contents_AddonModBookSlidesItemsManagerSource extends M.a{constructor(o,e,t,n){super(n?{id:n}:void 0),this.chapters=[],this.contentsMap={},this.COURSE_ID=o,this.CM_ID=e,this.TAGS_ENABLED=t}getItemId(o){return o.id}loadBookData(){return Object(_.a)(this,void 0,void 0,(function*(){if(this.module=yield C.a.getModule(this.CM_ID,this.COURSE_ID),this.book=yield T.a.getBook(this.COURSE_ID,this.CM_ID),!this.initialItem){const o=yield T.a.getLastChapterViewed(this.book.id);o&&(this.initialItem={id:o})}return{module:this.module,book:this.book}}))}loadContents(){return Object(_.a)(this,void 0,void 0,(function*(){if(!this.module)return;const o=yield C.a.getModuleContents(this.module,this.COURSE_ID);this.contentsMap=T.a.getContentsMap(o),this.chapters=T.a.getTocList(o)}))}loadItems(){return Object(_.a)(this,void 0,void 0,(function*(){try{return yield Promise.all(this.chapters.map((o=>Object(_.a)(this,void 0,void 0,(function*(){const e=yield T.a.getChapterContent(this.contentsMap,o.id,this.CM_ID);return{id:o.id,content:e,tags:this.TAGS_ENABLED?this.contentsMap[o.id].tags:[]}})))))}catch(o){if(!E.b.getErrorMessageFromError(o))throw new I.a(w.I.instant("addon.mod_book.errorchapter"));throw o}}))}invalidateContent(){return T.a.invalidateContent(this.CM_ID,this.COURSE_ID)}}const G=[{path:":courseId/:cmId",component:g},{path:":courseId/:cmId/contents",component:F}];let J=(()=>{class AddonModBookLazyModule{}return AddonModBookLazyModule.ɵmod=s.wc({type:AddonModBookLazyModule}),AddonModBookLazyModule.ɵinj=s.vc({factory:function AddonModBookLazyModule_Factory(o){return new(o||AddonModBookLazyModule)},imports:[[n.m.forChild(G),a.a,d.a,v.a]]}),AddonModBookLazyModule})();void(("undefined"==typeof ngJitMode||ngJitMode)&&s.kd(J,{declarations:[g,F],imports:[n.m,a.a,d.a,v.a]}))}}]);